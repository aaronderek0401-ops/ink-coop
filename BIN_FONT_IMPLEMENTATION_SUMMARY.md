# .bin å­—åº“ç”ŸæˆåŠŸèƒ½å®ç°æ€»ç»“

## ğŸ“ å®ç°æ¦‚è¿°

å·²æˆåŠŸåœ¨ `web_layout.html` çš„ TTFå­—ä½“ç®¡ç†åŒºåŸŸæ–°å¢äº† `.bin` å­—åº“æ–‡ä»¶ç”ŸæˆåŠŸèƒ½,è¯¥åŠŸèƒ½å®Œå…¨æ”¯æŒ `ChineseFontCache` æ··åˆç¼“å­˜ç³»ç»Ÿã€‚

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. Pythonåç«¯æ–°å¢API (ttf_to_gfx_webservice.py)

#### `/convert_ttf_to_bin` - ç”Ÿæˆ.binå­—åº“
```python
POST http://localhost:5000/convert_ttf_to_bin

è¯·æ±‚å‚æ•°:
{
    "ttf_base64": "base64ç¼–ç çš„TTFæ–‡ä»¶",
    "font_size": 16,          // 16, 24 æˆ– 32
    "font_name": "simhei",
    "char_range": "gb2312"
}

è¿”å›ç»“æœ:
{
    "success": true,
    "filename": "simhei_16x16.bin",
    "file_size_kb": 653.28,
    "char_count": 20902,
    "generated_count": 18000,
    "glyph_size": 32,
    "font_size": 16,
    "saved_path": "G:\\...\\components\\fonts\\simhei_16x16.bin",
    "format": {
        "unicode_range": "0x4E00 - 0x9FA5",
        "bytes_per_char": 32,
        "total_size": 668864,
        "usage": "offset = (unicode - 0x4E00) * 32"
    }
}
```

#### `/download_bin_file` - ä¸‹è½½.binæ–‡ä»¶
```python
GET http://localhost:5000/download_bin_file?filename=simhei_16x16.bin

è¿”å›: äºŒè¿›åˆ¶æ–‡ä»¶æµ
```

### 2. Webç•Œé¢æ–°å¢UIç»„ä»¶

#### ä½ç½®
`web_layout.html` â†’ TTFå­—ä½“ç®¡ç† â†’ .binå­—åº“ç”ŸæˆåŒºåŸŸ

#### UIå…ƒç´ 
```html
<!-- è“è‰²ä¿¡æ¯åŒºå— -->
<div style="background: #e3f2fd; ...">
    <h4>ğŸ“¦ æ··åˆç¼“å­˜ç³»ç»Ÿ - .binå­—åº“ç”Ÿæˆ</h4>
    
    <!-- å­—åº“å°ºå¯¸é€‰æ‹© -->
    <select id="binFontSize">
        <option value="16">16x16 (32å­—èŠ‚/å­—, ~650KB)</option>
        <option value="24">24x24 (72å­—èŠ‚/å­—, ~1.5MB)</option>
        <option value="32">32x32 (128å­—èŠ‚/å­—, ~2.6MB)</option>
    </select>
    
    <!-- åŠŸèƒ½æŒ‰é’® -->
    <button onclick="convertTTFtoBin()">ğŸ”„ ç”Ÿæˆ .bin å­—åº“æ–‡ä»¶</button>
    <button onclick="downloadBinFile()" id="downloadBinBtn">ğŸ’¾ ä¸‹è½½ .bin æ–‡ä»¶</button>
    <button onclick="uploadBinToSD()" id="uploadBinBtn">ğŸ“¤ ä¸Šä¼ åˆ° SD å¡</button>
    
    <!-- çŠ¶æ€æ˜¾ç¤º -->
    <div id="binGenerationStatus"></div>
</div>
```

### 3. JavaScriptåŠŸèƒ½å‡½æ•°

#### `convertTTFtoBin()` - ç”Ÿæˆ.binå­—åº“
- è¯»å–ä¸Šä¼ çš„TTFæ–‡ä»¶
- è½¬æ¢ä¸ºbase64
- è°ƒç”¨Python APIç”Ÿæˆ.binæ–‡ä»¶
- æ˜¾ç¤ºç”Ÿæˆè¿›åº¦å’Œç»“æœ
- è‡ªåŠ¨æ˜¾ç¤ºä¸‹è½½/ä¸Šä¼ æŒ‰é’®

#### `downloadBinFile()` - ä¸‹è½½åˆ°æœ¬åœ°
- ä»PythonæœåŠ¡è·å–.binæ–‡ä»¶
- è§¦å‘æµè§ˆå™¨ä¸‹è½½
- ä¿å­˜åˆ°æœ¬åœ°

#### `uploadBinToSD()` - ä¸Šä¼ åˆ°SDå¡
- ä»PythonæœåŠ¡è·å–.binæ–‡ä»¶
- è°ƒç”¨ `uploadFileToSD()` ä¸Šä¼ åˆ°ESP32
- ä¸Šä¼ åˆ°SDå¡æ ¹ç›®å½•
- æ˜¾ç¤ºæˆåŠŸæç¤ºå’Œä½¿ç”¨ç¤ºä¾‹

## ğŸ“¦ .binæ–‡ä»¶æ ¼å¼è¯¦è§£

### æ–‡ä»¶ç»“æ„
```
çº¯äºŒè¿›åˆ¶æ•°æ®,æ— æ–‡ä»¶å¤´
æŒ‰Unicodeé¡ºåºè¿ç»­å­˜å‚¨ (0x4E00 - 0x9FA5)
æ¯ä¸ªå­—ç¬¦å›ºå®šå­—èŠ‚æ•°

[0x4E00å­—æ¨¡] [0x4E01å­—æ¨¡] [0x4E02å­—æ¨¡] ... [0x9FA5å­—æ¨¡]
```

### å­—æ¨¡æ ¼å¼
```
16x16: æ¯è¡Œ2å­—èŠ‚,å…±16è¡Œ = 32å­—èŠ‚
24x24: æ¯è¡Œ3å­—èŠ‚,å…±24è¡Œ = 72å­—èŠ‚
32x32: æ¯è¡Œ4å­—èŠ‚,å…±32è¡Œ = 128å­—èŠ‚

ç¼–ç : MSB first (æœ€é«˜ä½åœ¨å·¦)
1 = åƒç´ ç‚¹äº®, 0 = åƒç´ å…³é—­
```

### ç´¢å¼•ç®—æ³•
```cpp
// æŸ¥æ‰¾å­—ç¬¦å­—æ¨¡
uint16_t unicode = 0x4F60;  // "ä½ "
uint32_t glyph_size = 32;   // 16x16

// è®¡ç®—åç§»
uint32_t offset = (unicode - 0x4E00) * glyph_size;

// è¯»å–å­—æ¨¡
fseek(fp, offset, SEEK_SET);
fread(buffer, 1, glyph_size, fp);
```

## ğŸ”— ä¸æ··åˆç¼“å­˜ç³»ç»Ÿé›†æˆ

### ChineseFontCache ä½¿ç”¨æ–¹å¼

```cpp
#include "chinese_font_cache.h"

void setup() {
    // 1. åˆå§‹åŒ–ç¼“å­˜ç³»ç»Ÿ
    ChineseFontCache& cache = getFontCache();
    cache.init("/sd/simhei_16x16.bin", true);
    
    // 2. åŠ è½½å¸¸ç”¨å­—åˆ°PSRAM
    cache.loadCommonCharacters();
    
    // 3. ä½¿ç”¨
    uint8_t glyph[32];
    getChineseChar(0x4F60, FONT_16x16, glyph);  // "ä½ "
}
```

### å®Œæ•´å·¥ä½œæµç¨‹

```
1. Webç•Œé¢ä¸Šä¼ TTF â†’ é€‰æ‹©å­—å· â†’ ç”Ÿæˆ.bin
2. ä¸‹è½½åˆ°æœ¬åœ° æˆ– ç›´æ¥ä¸Šä¼ åˆ°SDå¡
3. ESP32ä»£ç ä¸­åˆå§‹åŒ–ChineseFontCache
4. æŒ‡å®š.binæ–‡ä»¶è·¯å¾„
5. ç³»ç»Ÿè‡ªåŠ¨ä½¿ç”¨ä¸‰å±‚ç¼“å­˜:
   - å±‚çº§1: PSRAMå¸¸ç”¨å­— (500å­—, å¿«é€Ÿ)
   - å±‚çº§2: é¡µé¢ç¼“å­˜ (200å­—, åŠ¨æ€)
   - å±‚çº§3: SDå¡.binæ–‡ä»¶ (å…¨éƒ¨å­—ç¬¦, æŒ‰éœ€)
```

## ğŸ“ æ–‡ä»¶æ¸…å•

### ä¿®æ”¹çš„æ–‡ä»¶
1. **tools/ttf_to_gfx_webservice.py**
   - æ–°å¢ `/convert_ttf_to_bin` API
   - æ–°å¢ `/download_bin_file` API
   - æ›´æ–°å¯åŠ¨ä¿¡æ¯

2. **components/grbl_esp32s3/Grbl_Esp32/data/web_layout.html**
   - æ–°å¢UIåŒºåŸŸ (è“è‰²åŒºå—)
   - æ–°å¢3ä¸ªJavaScriptå‡½æ•°
   - é›†æˆåˆ°ç°æœ‰TTFç®¡ç†ç•Œé¢

### æ–°å¢çš„æ–‡æ¡£
3. **BL_add/ink_screen/BIN_FONT_GENERATION_GUIDE.md**
   - å®Œæ•´ä½¿ç”¨æŒ‡å—
   - æŠ€æœ¯ç»†èŠ‚è¯´æ˜
   - æ•…éšœæ’é™¤

4. **BL_add/ink_screen/BIN_FONT_TEST_CHECKLIST.md**
   - åŠŸèƒ½æµ‹è¯•æ¸…å•
   - éªŒè¯è„šæœ¬
   - æ€§èƒ½åŸºå‡†

### å·²å­˜åœ¨çš„ç›¸å…³æ–‡ä»¶
5. **BL_add/ink_screen/chinese_font_cache.h**
6. **BL_add/ink_screen/chinese_font_cache.cpp**
7. **BL_add/ink_screen/chinese_font_cache_example.cpp**
8. **BL_add/ink_screen/README_CHINESE_FONT_CACHE.md**

## ğŸš€ ä½¿ç”¨æµç¨‹ç¤ºä¾‹

### åœºæ™¯1: ç”Ÿæˆ16x16å­—åº“å¹¶ä¸Šä¼ åˆ°SDå¡

```bash
# æ­¥éª¤1: å¯åŠ¨PythonæœåŠ¡
cd g:\A_BL_Project\inkScree_fuben
python tools\ttf_to_gfx_webservice.py

# æ­¥éª¤2: æ‰“å¼€æµè§ˆå™¨
# è®¿é—® ESP32 çš„ web_layout.html

# æ­¥éª¤3: Webç•Œé¢æ“ä½œ
1. ä¸Šä¼  SimHei.ttf
2. é€‰æ‹© "16x16"
3. ç‚¹å‡» "ç”Ÿæˆ .bin å­—åº“æ–‡ä»¶"
4. ç­‰å¾…1-2åˆ†é’Ÿ
5. ç‚¹å‡» "ä¸Šä¼ åˆ° SD å¡"

# æ­¥éª¤4: ESP32ä»£ç 
cache.init("/sd/simhei_16x16.bin", true);
```

### åœºæ™¯2: ç”Ÿæˆå¤šä¸ªå­—å·çš„å­—åº“

```bash
# 16x16 - ç”¨äºå°å±å¹•
ç”Ÿæˆ â†’ ä¸‹è½½ â†’ é‡å‘½åä¸º font_16.bin

# 24x24 - ç”¨äºä¸­ç­‰å±å¹•
ç”Ÿæˆ â†’ ä¸‹è½½ â†’ é‡å‘½åä¸º font_24.bin

# 32x32 - ç”¨äºå¤§å±å¹•
ç”Ÿæˆ â†’ ä¸‹è½½ â†’ é‡å‘½åä¸º font_32.bin

# ESP32æ ¹æ®å±å¹•å¤§å°é€‰æ‹©
if (screen_size == SMALL) {
    cache.init("/sd/font_16.bin", true);
} else if (screen_size == MEDIUM) {
    cache.init("/sd/font_24.bin", true);
} else {
    cache.init("/sd/font_32.bin", true);
}
```

## ğŸ“Š æŠ€æœ¯æŒ‡æ ‡

### æ–‡ä»¶å¤§å°
| å­—å· | æ¯å­—èŠ‚æ•° | æ€»å¤§å° | SDå¡å ç”¨ |
|------|---------|--------|----------|
| 16x16 | 32 | 653 KB | å° |
| 24x24 | 72 | 1469 KB | ä¸­ |
| 32x32 | 128 | 2612 KB | å¤§ |

### ç”Ÿæˆæ€§èƒ½
- **16x16**: 1-2åˆ†é’Ÿ
- **24x24**: 2-3åˆ†é’Ÿ
- **32x32**: 3-5åˆ†é’Ÿ

### è¿è¡Œæ—¶æ€§èƒ½
- **å¸¸ç”¨å­—æŸ¥è¯¢**: <0.1ms (PSRAMç¼“å­˜)
- **é¡µé¢ç¼“å­˜**: <0.5ms (RAM)
- **SDå¡è¯»å–**: ~1ms (æœªç¼“å­˜)
- **å‘½ä¸­ç‡**: 80-90%

## âœ¨ ä¼˜åŠ¿ç‰¹ç‚¹

1. **ä¸€é”®ç”Ÿæˆ**: Webç•Œé¢ç®€å•æ“ä½œ,æ— éœ€æ‰‹åŠ¨ç¼–å†™è„šæœ¬
2. **æ ¼å¼å…¼å®¹**: å®Œå…¨ç¬¦åˆChineseFontCacheçš„æ–‡ä»¶æ ¼å¼è¦æ±‚
3. **å¤šå­—å·æ”¯æŒ**: 16/24/32ä¸‰ç§å¸¸ç”¨å°ºå¯¸
4. **å³æ—¶ä¸Šä¼ **: å¯ç›´æ¥ä¸Šä¼ åˆ°ESP32 SDå¡,æ— éœ€æ‰‹åŠ¨æ‹·è´
5. **è¿›åº¦åé¦ˆ**: å®æ—¶æ˜¾ç¤ºç”Ÿæˆè¿›åº¦å’Œè¯¦ç»†ä¿¡æ¯
6. **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯æç¤ºå’Œæ•…éšœæ’é™¤
7. **æ–‡æ¡£é½å…¨**: ä½¿ç”¨æŒ‡å—ã€æµ‹è¯•æ¸…å•ã€æŠ€æœ¯æ–‡æ¡£

## ğŸ¯ åº”ç”¨åœºæ™¯

### âœ… é€‚åˆçš„åœºæ™¯
- ç”µå­ä¹¦é˜…è¯»å™¨ (å¤§é‡æ±‰å­—æ˜¾ç¤º)
- å•è¯å¡ç‰‡åº”ç”¨ (ä¸­æ–‡é‡Šä¹‰)
- èœå•ç•Œé¢ (ä¸­æ–‡æ ‡ç­¾)
- ä¿¡æ¯æ˜¾ç¤ºå± (å®æ—¶ä¿¡æ¯)

### âš ï¸ æ³¨æ„äº‹é¡¹
- å­—ä½“æ–‡ä»¶å¿…é¡»åŒ…å«ä¸­æ–‡å­—ç¬¦
- SDå¡éœ€è¦è¶³å¤Ÿç©ºé—´ (1-3MB)
- ç”Ÿæˆè¿‡ç¨‹éœ€è¦è€å¿ƒç­‰å¾…
- æ¨èä½¿ç”¨16x16ä»¥èŠ‚çœç©ºé—´

## ğŸ”§ å¾…ä¼˜åŒ–é¡¹

1. **æ€§èƒ½ä¼˜åŒ–**
   - [ ] å¤šçº¿ç¨‹ç”Ÿæˆ,æå‡é€Ÿåº¦
   - [ ] å¢é‡ç”Ÿæˆ,åªç”Ÿæˆå˜åŒ–çš„å­—ç¬¦
   - [ ] å‹ç¼©å­˜å‚¨,å‡å°æ–‡ä»¶ä½“ç§¯

2. **åŠŸèƒ½å¢å¼º**
   - [ ] è‡ªå®šä¹‰UnicodeèŒƒå›´
   - [ ] æ”¯æŒå¤šå­—ä½“åˆå¹¶
   - [ ] é¢„è§ˆç”Ÿæˆçš„å­—æ¨¡

3. **ç”¨æˆ·ä½“éªŒ**
   - [ ] ç”Ÿæˆè¿›åº¦æ¡æ˜¾ç¤º
   - [ ] æ–­ç‚¹ç»­ä¼ æ”¯æŒ
   - [ ] æ‰¹é‡ç”Ÿæˆå¤šä¸ªå­—å·

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### è°ƒè¯•æ–¹æ³•
1. **æµè§ˆå™¨æ§åˆ¶å°**: æŸ¥çœ‹JavaScripté”™è¯¯
2. **Pythonç»ˆç«¯**: æŸ¥çœ‹åç«¯æ—¥å¿—
3. **ESP32ä¸²å£**: æŸ¥çœ‹è¿è¡Œæ—¶é”™è¯¯

### å¸¸è§é—®é¢˜
- ç”Ÿæˆå¤±è´¥ â†’ æ£€æŸ¥PythonæœåŠ¡
- ä¸Šä¼ å¤±è´¥ â†’ æ£€æŸ¥SDå¡è¿æ¥
- æ˜¾ç¤ºå¼‚å¸¸ â†’ éªŒè¯.binæ–‡ä»¶å®Œæ•´æ€§

## ğŸ“… ç‰ˆæœ¬ä¿¡æ¯

- **åŠŸèƒ½ç‰ˆæœ¬**: v1.0
- **å®ç°æ—¥æœŸ**: 2025å¹´12æœˆ13æ—¥
- **å…¼å®¹ç³»ç»Ÿ**: ChineseFontCache v1.0+
- **Pythonè¦æ±‚**: 3.6+
- **ä¾èµ–åº“**: Flask, Pillow, flask-cors

---

**å®ç°å®Œæˆ** âœ…  
**æµ‹è¯•çŠ¶æ€**: å¾…æµ‹è¯•  
**æ–‡æ¡£çŠ¶æ€**: å·²å®Œæˆ

ä¸‹ä¸€æ­¥: è¿è¡ŒåŠŸèƒ½æµ‹è¯•,éªŒè¯å®Œæ•´æµç¨‹
