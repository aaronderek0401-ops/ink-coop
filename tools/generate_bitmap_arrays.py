#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ç”Ÿæˆç‹¬ç«‹çš„ä¸­æ–‡å­—ç¬¦ä½å›¾ï¼ˆæ¯ä¸ªå­—ç¬¦ä¸€ä¸ªæ•°ç»„ï¼‰
é¿å… GFX å­—ä½“çš„ Unicode èŒƒå›´é—®é¢˜
"""

from PIL import Image, ImageDraw, ImageFont
import os

# é…ç½®
TTF_PATH = "components/fonts/ä»¿å®‹_GB2312.ttf"
CHARS = "æµ‹è¯•æ–‡å­—"  # åªè½¬æ¢ä¸­æ–‡
FONT_SIZE = 16
OUTPUT_NAME = "fangsong_bitmaps"

def generate_bitmap_arrays():
    """ä¸ºæ¯ä¸ªå­—ç¬¦ç”Ÿæˆç‹¬ç«‹çš„ä½å›¾æ•°ç»„"""
    
    print("ğŸ”„ æ­£åœ¨ç”Ÿæˆç‹¬ç«‹ä½å›¾æ•°ç»„...")
    print(f"ğŸ“ å­—ä½“: {TTF_PATH}")
    print(f"ğŸ“ å­—ç¬¦: {CHARS}")
    print()
    
    if not os.path.exists(TTF_PATH):
        print(f"âŒ å­—ä½“æ–‡ä»¶ä¸å­˜åœ¨")
        return
    
    try:
        font = ImageFont.truetype(TTF_PATH, FONT_SIZE)
        print("âœ… å­—ä½“åŠ è½½æˆåŠŸ")
    except Exception as e:
        print(f"âŒ åŠ è½½å¤±è´¥: {e}")
        return
    
    h_content = f"""// Font Bitmaps: {OUTPUT_NAME} {FONT_SIZE}pt
// Generated by generate_bitmap_arrays.py
// Characters: {CHARS}
// æ¯ä¸ªå­—ç¬¦ä¸€ä¸ªç‹¬ç«‹çš„ä½å›¾æ•°ç»„

#ifndef _{OUTPUT_NAME.upper()}_{FONT_SIZE}PT_H_
#define _{OUTPUT_NAME.upper()}_{FONT_SIZE}PT_H_

#include <Arduino.h>

"""
    
    char_info = []
    
    for char in CHARS:
        bbox = font.getbbox(char)
        width = bbox[2] - bbox[0]
        height = bbox[3] - bbox[1]
        
        if width <= 0 or height <= 0:
            print(f"âš ï¸  '{char}' å°ºå¯¸ä¸º0ï¼Œè·³è¿‡")
            continue
        
        # åˆ›å»ºå›¾åƒ
        img = Image.new('1', (width, height), 1)
        draw = ImageDraw.Draw(img)
        draw.text((-bbox[0], -bbox[1]), char, font=font, fill=0)
        
        # è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„
        pixels = list(img.getdata())
        bitmap_bytes = []
        
        for y in range(height):
            for x in range(0, width, 8):
                byte = 0
                for bit in range(8):
                    if x + bit < width:
                        if pixels[y * width + x + bit] == 0:
                            byte |= (0x80 >> bit)
                bitmap_bytes.append(byte)
        
        # ç”Ÿæˆæ•°ç»„åï¼ˆä½¿ç”¨ Unicode ç ç‚¹ï¼‰
        array_name = f"BITMAP_{ord(char):04X}"
        
        # å†™å…¥æ•°ç»„å®šä¹‰
        h_content += f"// '{char}' (U+{ord(char):04X}) - {width}x{height}\n"
        h_content += f"const uint8_t {array_name}[] PROGMEM = {{\n"
        h_content += "    "
        
        for i, byte in enumerate(bitmap_bytes):
            h_content += f"0x{byte:02X}"
            if i < len(bitmap_bytes) - 1:
                h_content += ", "
            if (i + 1) % 16 == 0 and i < len(bitmap_bytes) - 1:
                h_content += "\n    "
        
        h_content += "\n};\n\n"
        
        char_info.append({
            'char': char,
            'unicode': ord(char),
            'width': width,
            'height': height,
            'array_name': array_name,
            'size': len(bitmap_bytes)
        })
        
        print(f"âœ“ '{char}' (U+{ord(char):04X}): {width}x{height}, {len(bitmap_bytes)} bytes -> {array_name}")
    
    # ç”Ÿæˆç»˜åˆ¶å‡½æ•°
    h_content += f"""// ç»˜åˆ¶å‡½æ•°æ¨¡æ¿ï¼ˆæ”¯æŒä»»æ„ GxEPD2 æ˜¾ç¤ºå™¨ç±»å‹ï¼‰
template<typename T>
inline void draw{OUTPUT_NAME.title().replace('_', '')}(T& display, int16_t x, int16_t y, uint16_t scale = 1) {{
"""
    
    x_offset = 0
    for info in char_info:
        h_content += f"    // '{info['char']}'\n"
        h_content += f"    for (uint16_t s_y = 0; s_y < {info['height']} * scale; s_y++) {{\n"
        h_content += f"        for (uint16_t s_x = 0; s_x < {info['width']} * scale; s_x++) {{\n"
        h_content += f"            uint16_t src_x = s_x / scale;\n"
        h_content += f"            uint16_t src_y = s_y / scale;\n"
        h_content += f"            uint16_t byte_index = src_y * (({info['width']} + 7) / 8) + src_x / 8;\n"
        h_content += f"            uint8_t bit_mask = 0x80 >> (src_x % 8);\n"
        h_content += f"            if (pgm_read_byte(&{info['array_name']}[byte_index]) & bit_mask) {{\n"
        h_content += f"                display.drawPixel(x + {x_offset} * scale + s_x, y + s_y, GxEPD_BLACK);\n"
        h_content += f"            }}\n"
        h_content += f"        }}\n"
        h_content += f"    }}\n\n"
        x_offset += info['width'] + 1  # å­—ç¬¦é—´è·
    
    h_content += "}\n\n"
    
    h_content += f"#endif // _{OUTPUT_NAME.upper()}_{FONT_SIZE}PT_H_\n"
    
    # ä¿å­˜æ–‡ä»¶
    output_path = f"components/fonts/{OUTPUT_NAME}{FONT_SIZE}pt.h"
    
    with open(output_path, 'w', encoding='utf-8') as f:
        f.write(h_content)
    
    print()
    print(f"âœ… ç”ŸæˆæˆåŠŸ: {output_path}")
    print()
    print("=" * 60)
    print("ä½¿ç”¨æ–¹æ³•:")
    print("=" * 60)
    print(f"#include \"../fonts/{OUTPUT_NAME}{FONT_SIZE}pt.h\"")
    print(f"drawFangsongBitmaps(display, 10, 50, 2);  // x, y, scale")
    print("=" * 60)

if __name__ == "__main__":
    generate_bitmap_arrays()
