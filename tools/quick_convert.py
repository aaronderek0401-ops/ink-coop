#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
å¿«é€Ÿè½¬æ¢ Comic Sans MS Bold å­—ä½“
"""

from PIL import Image, ImageDraw, ImageFont
import os

# é…ç½®
TTF_PATH = "components/fonts/ä»¿å®‹_GB2312.ttf"
CHARS = "æµ‹è¯•æ–‡å­—ABC123"
FONT_SIZE = 16
OUTPUT_NAME = "fangsong_chinese"

def generate_gfx_font():
    """ç”Ÿæˆ GFX æ ¼å¼å­—ä½“"""
    
    print(f"ğŸ”„ æ­£åœ¨è½¬æ¢å­—ä½“...")
    print(f"ğŸ“ å­—ä½“æ–‡ä»¶: {TTF_PATH}")
    print(f"ğŸ“ å­—ç¬¦: {CHARS}")
    print(f"ğŸ“ å­—å·: {FONT_SIZE}")
    print()
    
    if not os.path.exists(TTF_PATH):
        print(f"âŒ å­—ä½“æ–‡ä»¶ä¸å­˜åœ¨: {TTF_PATH}")
        return
    
    try:
        font = ImageFont.truetype(TTF_PATH, FONT_SIZE)
        print("âœ… å­—ä½“åŠ è½½æˆåŠŸ")
    except Exception as e:
        print(f"âŒ åŠ è½½å­—ä½“å¤±è´¥: {e}")
        return
    
    # æŒ‰ Unicode æ’åºï¼ˆé‡è¦ï¼ï¼‰
    sorted_chars = sorted(set(CHARS), key=lambda c: ord(c))
    
    bitmaps = []
    glyphs = []
    bitmap_offset = 0
    
    # ä¸ºæ¯ä¸ªå­—ç¬¦ç”Ÿæˆä½å›¾
    for char in sorted_chars:
        try:
            # è·å–å­—ç¬¦è¾¹ç•Œ
            bbox = font.getbbox(char)
            width = bbox[2] - bbox[0]
            height = bbox[3] - bbox[1]
            x_offset = bbox[0]
            y_offset = -bbox[3]
            
            if width <= 0 or height <= 0:
                print(f"âš ï¸  å­—ç¬¦ '{char}' (U+{ord(char):04X}) å°ºå¯¸ä¸º0ï¼Œè·³è¿‡")
                continue
            
            # åˆ›å»ºå›¾åƒ
            img = Image.new('1', (width, height), 1)
            draw = ImageDraw.Draw(img)
            draw.text((-bbox[0], -bbox[1]), char, font=font, fill=0)
            
            # è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„ (æŒ‰è¡Œæ‰«æï¼Œæ¯8ä¸ªåƒç´ ä¸€ä¸ªå­—èŠ‚)
            pixels = list(img.getdata())
            bitmap_bytes = []
            
            for y in range(height):
                for x in range(0, width, 8):
                    byte = 0
                    for bit in range(8):
                        if x + bit < width:
                            pixel_index = y * width + x + bit
                            if pixels[pixel_index] == 0:  # é»‘è‰²åƒç´ 
                                byte |= (0x80 >> bit)
                    bitmap_bytes.append(byte)
            
            bitmaps.extend(bitmap_bytes)
            
            # è®¡ç®— x_advance (å­—ç¬¦å®½åº¦ + é—´è·)
            x_advance = width + 1
            
            # ç”Ÿæˆ Glyph ä¿¡æ¯
            glyphs.append({
                'char': char,
                'unicode': ord(char),
                'bitmap_offset': bitmap_offset,
                'width': width,
                'height': height,
                'x_advance': x_advance,
                'x_offset': x_offset,
                'y_offset': y_offset,
                'bitmap_size': len(bitmap_bytes)
            })
            
            bitmap_offset += len(bitmap_bytes)
            
            print(f"âœ“ '{char}' (U+{ord(char):04X}): {width}x{height}, {len(bitmap_bytes)} bytes")
            
        except Exception as e:
            print(f"âŒ å¤„ç†å­—ç¬¦ '{char}' å¤±è´¥: {e}")
            continue
    
    if len(glyphs) == 0:
        print("âŒ æ²¡æœ‰æˆåŠŸè½¬æ¢ä»»ä½•å­—ç¬¦")
        return
    
    print()
    print(f"âœ… æˆåŠŸè½¬æ¢ {len(glyphs)} ä¸ªå­—ç¬¦")
    print(f"ğŸ“Š æ€»ä½å›¾å¤§å°: {len(bitmaps)} bytes")
    print()
    
    # ç”Ÿæˆ .h æ–‡ä»¶
    first_char = glyphs[0]['unicode']
    last_char = glyphs[-1]['unicode']
    
    h_content = f"""// Font: {OUTPUT_NAME} {FONT_SIZE}pt
// Generated by quick_convert.py
// Characters: {CHARS}
// Character count: {len(glyphs)}
// Bitmap size: {len(bitmaps)} bytes

#ifndef _{OUTPUT_NAME.upper()}_{FONT_SIZE}PT7B_H_
#define _{OUTPUT_NAME.upper()}_{FONT_SIZE}PT7B_H_

#include <Adafruit_GFX.h>

const uint8_t {OUTPUT_NAME}{FONT_SIZE}ptBitmaps[] PROGMEM = {{
"""
    
    # ä½å›¾æ•°æ®
    for i, byte in enumerate(bitmaps):
        if i % 16 == 0:
            h_content += "    "
        h_content += f"0x{byte:02X}"
        if i < len(bitmaps) - 1:
            h_content += ", "
        if (i + 1) % 16 == 0 and i < len(bitmaps) - 1:
            h_content += "\n"
    
    h_content += "\n};\n\n"
    
    # Glyphs æ•°æ®
    h_content += f"const GFXglyph {OUTPUT_NAME}{FONT_SIZE}ptGlyphs[] PROGMEM = {{\n"
    
    for g in glyphs:
        h_content += f"    {{ {g['bitmap_offset']:5d}, {g['width']:3d}, {g['height']:3d}, "
        h_content += f"{g['x_advance']:3d}, {g['x_offset']:4d}, {g['y_offset']:4d} }}"
        h_content += f",  // U+{g['unicode']:04X} '{g['char']}'\n"
    
    h_content = h_content.rstrip(',\n') + '\n'  # ç§»é™¤æœ€åçš„é€—å·
    h_content += "};\n\n"
    
    # Font ç»“æ„
    h_content += f"""const GFXfont {OUTPUT_NAME}{FONT_SIZE}pt7b PROGMEM = {{
    (uint8_t *){OUTPUT_NAME}{FONT_SIZE}ptBitmaps,
    (GFXglyph *){OUTPUT_NAME}{FONT_SIZE}ptGlyphs,
    0x{first_char:04X}, 0x{last_char:04X}, {FONT_SIZE}
}};

#endif // _{OUTPUT_NAME.upper()}_{FONT_SIZE}PT7B_H_
"""
    
    # ä¿å­˜æ–‡ä»¶
    output_path = f"components/fonts/{OUTPUT_NAME}{FONT_SIZE}pt7b.h"
    
    with open(output_path, 'w', encoding='utf-8') as f:
        f.write(h_content)
    
    print(f"âœ… æ–‡ä»¶å·²ç”Ÿæˆ: {output_path}")
    print()
    print("=" * 60)
    print("ä½¿ç”¨æ–¹æ³•:")
    print("=" * 60)
    print(f"#include \"../fonts/{OUTPUT_NAME}{FONT_SIZE}pt7b.h\"")
    print(f"display.setFont(&{OUTPUT_NAME}{FONT_SIZE}pt7b);")
    print(f'display.print("{CHARS}");')
    print("=" * 60)

if __name__ == "__main__":
    generate_gfx_font()
