#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ç”Ÿæˆä»¿å®‹_GB2312å­—ä½“çš„GFXæ ¼å¼æ–‡ä»¶
å­—ç¬¦: æµ‹è¯•æ–‡å­—ABC123
"""

from PIL import Image, ImageDraw, ImageFont
import os

# é…ç½®
TTF_PATH = r"G:\A_BL_Project\inkScree_fuben\ä»¿å®‹_GB2312.ttf"  # ä¿®æ”¹ä¸ºä½ çš„å­—ä½“è·¯å¾„
CHARS = "æµ‹è¯•æ–‡å­—ABC123"
FONT_SIZE = 16
OUTPUT_NAME = "fangsong_GB2312"

def generate_gfx_font():
    """ç”Ÿæˆ GFX æ ¼å¼å­—ä½“"""
    if not os.path.exists(TTF_PATH):
        print(f"âŒ å­—ä½“æ–‡ä»¶ä¸å­˜åœ¨: {TTF_PATH}")
        print("è¯·å°†ä»¿å®‹_GB2312.ttfæ”¾åˆ°é¡¹ç›®æ ¹ç›®å½•ï¼Œæˆ–ä¿®æ”¹ TTF_PATH å˜é‡")
        return
    
    try:
        font = ImageFont.truetype(TTF_PATH, FONT_SIZE)
    except Exception as e:
        print(f"âŒ åŠ è½½å­—ä½“å¤±è´¥: {e}")
        return
    
    bitmaps = []
    glyphs = []
    
    # ä¸ºæ¯ä¸ªå­—ç¬¦ç”Ÿæˆä½å›¾
    for char in CHARS:
        # è·å–å­—ç¬¦è¾¹ç•Œ
        bbox = font.getbbox(char)
        width = bbox[2] - bbox[0]
        height = bbox[3] - bbox[1]
        
        if width == 0 or height == 0:
            print(f"âš ï¸ å­—ç¬¦ '{char}' å°ºå¯¸ä¸º0ï¼Œè·³è¿‡")
            continue
        
        # åˆ›å»ºå›¾åƒ
        img = Image.new('1', (width, height), 1)
        draw = ImageDraw.Draw(img)
        draw.text((-bbox[0], -bbox[1]), char, font=font, fill=0)
        
        # è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„
        pixels = list(img.getdata())
        bitmap_bytes = []
        
        for y in range(height):
            for x in range(0, width, 8):
                byte = 0
                for bit in range(8):
                    if x + bit < width:
                        if pixels[y * width + x + bit] == 0:
                            byte |= (0x80 >> bit)
                bitmap_bytes.append(byte)
        
        bitmaps.extend(bitmap_bytes)
        
        # ç”Ÿæˆ Glyph ä¿¡æ¯
        glyphs.append({
            'char': char,
            'bitmap_offset': len(bitmaps) - len(bitmap_bytes),
            'width': width,
            'height': height,
            'x_advance': width + 1,
            'x_offset': bbox[0],
            'y_offset': -bbox[3]
        })
    
    # ç”Ÿæˆ .h æ–‡ä»¶
    h_content = f"""// Font: {OUTPUT_NAME} {FONT_SIZE}pt
// Generated by convert_fangsong.py
// Characters: {CHARS}

#ifndef _{OUTPUT_NAME.upper()}_{FONT_SIZE}PT_H_
#define _{OUTPUT_NAME.upper()}_{FONT_SIZE}PT_H_

#include <Adafruit_GFX.h>

const uint8_t {OUTPUT_NAME}{FONT_SIZE}ptBitmaps[] PROGMEM = {{
"""
    
    # ä½å›¾æ•°æ®
    for i, byte in enumerate(bitmaps):
        if i % 16 == 0:
            h_content += "    "
        h_content += f"0x{byte:02X}"
        if i < len(bitmaps) - 1:
            h_content += ", "
        if (i + 1) % 16 == 0:
            h_content += "\n"
    
    h_content += "\n};\n\n"
    
    # Glyphs æ•°æ®
    h_content += f"const GFXglyph {OUTPUT_NAME}{FONT_SIZE}ptGlyphs[] PROGMEM = {{\n"
    
    for g in glyphs:
        h_content += f"    {{ {g['bitmap_offset']:5d}, {g['width']:3d}, {g['height']:3d}, "
        h_content += f"{g['x_advance']:3d}, {g['x_offset']:4d}, {g['y_offset']:4d} }}"
        h_content += f"  // '{g['char']}'\n"
    
    h_content += "};\n\n"
    
    # Font ç»“æ„
    first_char = ord(CHARS[0])
    last_char = ord(CHARS[-1])
    
    h_content += f"""const GFXfont {OUTPUT_NAME}{FONT_SIZE}pt PROGMEM = {{
    (uint8_t *){OUTPUT_NAME}{FONT_SIZE}ptBitmaps,
    (GFXglyph *){OUTPUT_NAME}{FONT_SIZE}ptGlyphs,
    0x{first_char:04X}, 0x{last_char:04X}, {FONT_SIZE}
}};

#endif // _{OUTPUT_NAME.upper()}_{FONT_SIZE}PT_H_
"""
    
    # ä¿å­˜æ–‡ä»¶
    output_path = f"components/fonts/{OUTPUT_NAME}{FONT_SIZE}pt7b.h"
    os.makedirs(os.path.dirname(output_path), exist_ok=True)
    
    with open(output_path, 'w', encoding='utf-8') as f:
        f.write(h_content)
    
    print(f"âœ… è½¬æ¢æˆåŠŸï¼")
    print(f"ğŸ“ è¾“å‡ºæ–‡ä»¶: {output_path}")
    print(f"ğŸ“Š å­—ç¬¦æ•°: {len(glyphs)}")
    print(f"ğŸ“Š ä½å›¾å¤§å°: {len(bitmaps)} bytes")
    print(f"\nä½¿ç”¨æ–¹æ³•:")
    print(f"  #include \"../fonts/{OUTPUT_NAME}{FONT_SIZE}pt7b.h\"")

if __name__ == "__main__":
    generate_gfx_font()
