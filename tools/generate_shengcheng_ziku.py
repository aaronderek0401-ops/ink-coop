#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ç”Ÿæˆ "ç”Ÿæˆå­—åº“" ç‹¬ç«‹ä½å›¾ï¼ˆé«˜è´¨é‡ Python ç‰ˆæœ¬ï¼‰
é¿å…æµè§ˆå™¨ Canvas æ¸²æŸ“è´¨é‡ä¸è¶³çš„é—®é¢˜
"""

from PIL import Image, ImageDraw, ImageFont
import os
import sys

# è·å–é¡¹ç›®æ ¹ç›®å½•
SCRIPT_DIR = os.path.dirname(os.path.abspath(__file__))
PROJECT_ROOT = os.path.dirname(SCRIPT_DIR)

# é…ç½®
TTF_PATH = os.path.join(PROJECT_ROOT, "components", "fonts", "ä»¿å®‹_GB2312.ttf")
CHARS = "ç”Ÿæˆå­—åº“"  # è¦è½¬æ¢çš„å­—ç¬¦
FONT_SIZE = 16
OUTPUT_NAME = "fangsong_shengcheng"

def generate_bitmap_arrays():
    """ä¸ºæ¯ä¸ªå­—ç¬¦ç”Ÿæˆç‹¬ç«‹çš„ä½å›¾æ•°ç»„"""
    
    print("ğŸ”„ æ­£åœ¨ç”Ÿæˆç‹¬ç«‹ä½å›¾æ•°ç»„...")
    print(f"ğŸ“ å­—ä½“: {TTF_PATH}")
    print(f"ğŸ“ å­—ç¬¦: {CHARS}")
    print(f"ğŸ“ å­—å·: {FONT_SIZE}pt")
    print()
    
    if not os.path.exists(TTF_PATH):
        print(f"âŒ å­—ä½“æ–‡ä»¶ä¸å­˜åœ¨: {TTF_PATH}")
        return
    
    try:
        font = ImageFont.truetype(TTF_PATH, FONT_SIZE)
        print("âœ… å­—ä½“åŠ è½½æˆåŠŸ")
    except Exception as e:
        print(f"âŒ åŠ è½½å¤±è´¥: {e}")
        return
    
    h_content = f"""// Font Bitmaps: {OUTPUT_NAME} {FONT_SIZE}pt
// Generated by generate_shengcheng_ziku.py (Python + Pillow)
// Characters: {CHARS}
// æ¯ä¸ªå­—ç¬¦ä¸€ä¸ªç‹¬ç«‹çš„ä½å›¾æ•°ç»„ï¼ˆé«˜è´¨é‡æ¸²æŸ“ï¼‰

#ifndef _{OUTPUT_NAME.upper()}_{FONT_SIZE}PT_H_
#define _{OUTPUT_NAME.upper()}_{FONT_SIZE}PT_H_

#include <Arduino.h>

"""
    
    char_info = []
    
    for char in CHARS:
        bbox = font.getbbox(char)
        width = bbox[2] - bbox[0]
        height = bbox[3] - bbox[1]
        
        if width <= 0 or height <= 0:
            print(f"âš ï¸  '{char}' å°ºå¯¸ä¸º0ï¼Œè·³è¿‡")
            continue
        
        # åˆ›å»ºå›¾åƒ
        img = Image.new('1', (width, height), 1)
        draw = ImageDraw.Draw(img)
        draw.text((-bbox[0], -bbox[1]), char, font=font, fill=0)
        
        # è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„
        pixels = list(img.getdata())
        bitmap_bytes = []
        
        for y in range(height):
            for x in range(0, width, 8):
                byte = 0
                for bit in range(8):
                    if x + bit < width:
                        if pixels[y * width + x + bit] == 0:
                            byte |= (0x80 >> bit)
                bitmap_bytes.append(byte)
        
        # ç”Ÿæˆæ•°ç»„åï¼ˆä½¿ç”¨ Unicode ç ç‚¹ï¼‰
        array_name = f"BITMAP_{ord(char):04X}"
        
        # å†™å…¥æ•°ç»„å®šä¹‰
        h_content += f"// '{char}' (U+{ord(char):04X}) - {width}x{height}\n"
        h_content += f"const uint8_t {array_name}[] PROGMEM = {{\n"
        h_content += "    "
        
        for i, byte in enumerate(bitmap_bytes):
            h_content += f"0x{byte:02X}"
            if i < len(bitmap_bytes) - 1:
                h_content += ", "
            if (i + 1) % 16 == 0 and i < len(bitmap_bytes) - 1:
                h_content += "\n    "
        
        h_content += "\n};\n\n"
        
        char_info.append({
            'char': char,
            'unicode': ord(char),
            'width': width,
            'height': height,
            'array_name': array_name,
            'size': len(bitmap_bytes)
        })
        
        print(f"âœ“ '{char}' (U+{ord(char):04X}): {width}x{height}, {len(bitmap_bytes)} bytes -> {array_name}")
    
    # ç”Ÿæˆå•å­—ç¬¦ç»˜åˆ¶å‡½æ•°
    h_content += f"""// ç»˜åˆ¶å•ä¸ªå­—ç¬¦
template<typename T>
void draw{OUTPUT_NAME.title().replace('_', '')}Char(T& display, int16_t x, int16_t y, uint16_t charCode) {{
    const uint8_t* bitmap = nullptr;
    uint8_t width = 0, height = {FONT_SIZE};

    switch(charCode) {{
"""
    
    for info in char_info:
        h_content += f"        case 0x{info['unicode']:04X}: bitmap = {info['array_name']}; width = {info['width']}; height = {info['height']}; break;\n"
    
    h_content += """        default: return; // æœªçŸ¥å­—ç¬¦
    }

    if (bitmap) {
        display.drawBitmap(x, y, bitmap, width, height, GxEPD_BLACK);
    }
}

// ç»˜åˆ¶ UTF-8 å­—ç¬¦ä¸²
template<typename T>
void draw"""
    
    h_content += f"""{OUTPUT_NAME.title().replace('_', '')}String(T& display, int16_t x, int16_t y, const char* text) {{
    int16_t currentX = x;
    const uint8_t* p = (const uint8_t*)text;

    while (*p) {{
        uint16_t charCode = 0;
        // UTF-8 è§£ç 
        if ((*p & 0x80) == 0) {{  // 1å­—èŠ‚ ASCII
            charCode = *p++;
        }} else if ((*p & 0xE0) == 0xC0) {{  // 2å­—èŠ‚
            charCode = ((*p++ & 0x1F) << 6);
            charCode |= (*p++ & 0x3F);
        }} else if ((*p & 0xF0) == 0xE0) {{  // 3å­—èŠ‚ï¼ˆä¸­æ–‡ï¼‰
            charCode = ((*p++ & 0x0F) << 12);
            charCode |= ((*p++ & 0x3F) << 6);
            charCode |= (*p++ & 0x3F);
        }} else if ((*p & 0xF8) == 0xF0) {{  // 4å­—èŠ‚
            charCode = ((*p++ & 0x07) << 18);
            charCode |= ((*p++ & 0x3F) << 12);
            charCode |= ((*p++ & 0x3F) << 6);
            charCode |= (*p++ & 0x3F);
        }} else {{
            p++;  // è·³è¿‡æ— æ•ˆå­—èŠ‚
            continue;
        }}

        // ç»˜åˆ¶å­—ç¬¦å¹¶ç§»åŠ¨å…‰æ ‡
        draw{OUTPUT_NAME.title().replace('_', '')}Char(display, currentX, y, charCode);
        
        // æ ¹æ®å®é™…å­—ç¬¦å®½åº¦ç§»åŠ¨ï¼ˆæŸ¥è¡¨è·å–ç²¾ç¡®å®½åº¦ï¼‰
"""
    
    # æ·»åŠ å­—ç¬¦å®½åº¦è¡¨
    h_content += "        uint8_t charWidth = 16;  // é»˜è®¤å®½åº¦\n"
    h_content += "        switch(charCode) {\n"
    for info in char_info:
        h_content += f"            case 0x{info['unicode']:04X}: charWidth = {info['width']}; break;\n"
    h_content += "        }\n"
    h_content += "        currentX += charWidth + 1;  // å­—ç¬¦å®½åº¦ + 1åƒç´ é—´éš”\n"
    h_content += "    }\n"
    h_content += "}\n\n"
    
    h_content += f"#endif // _{OUTPUT_NAME.upper()}_{FONT_SIZE}PT_H_\n"
    
    # ä¿å­˜æ–‡ä»¶
    output_path = os.path.join(PROJECT_ROOT, "components", "fonts", f"{OUTPUT_NAME}{FONT_SIZE}pt.h")
    
    with open(output_path, 'w', encoding='utf-8') as f:
        f.write(h_content)
    
    print()
    print(f"âœ… ç”ŸæˆæˆåŠŸ: {output_path}")
    print()
    print("=" * 60)
    print("ä½¿ç”¨æ–¹æ³•:")
    print("=" * 60)
    print(f"#include \"../fonts/{OUTPUT_NAME}{FONT_SIZE}pt.h\"")
    print(f"draw{OUTPUT_NAME.title().replace('_', '')}String(display, 10, 200, \"{CHARS}\");")
    print("=" * 60)

if __name__ == "__main__":
    generate_bitmap_arrays()
