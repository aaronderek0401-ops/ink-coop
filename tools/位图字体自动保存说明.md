# ä½å›¾å­—ä½“è‡ªåŠ¨ä¿å­˜åŠŸèƒ½ä½¿ç”¨è¯´æ˜

## ğŸ“‹ åŠŸèƒ½è¯´æ˜

ç°åœ¨ web_layout.html çš„ä½å›¾è½¬æ¢åŠŸèƒ½æ”¯æŒ**åŒé‡ä¿å­˜**:
1. âœ… **æµè§ˆå™¨ä¸‹è½½** - è‡ªåŠ¨ä¸‹è½½ `.h` æ–‡ä»¶åˆ°æµè§ˆå™¨ä¸‹è½½ç›®å½•
2. âœ… **æœ¬åœ°ä¿å­˜** - è‡ªåŠ¨ä¿å­˜åˆ°é¡¹ç›®çš„ `components/fonts/` ç›®å½•

---

## ğŸš€ å¯åŠ¨æ­¥éª¤

### æ­¥éª¤ 1: å¯åŠ¨ Python æœåŠ¡

æ‰“å¼€ç»ˆç«¯,è¿è¡Œ:

```powershell
python tools/ttf_to_gfx_webservice.py
```

**è¾“å‡ºç¤ºä¾‹:**
```
============================================================
TTF è½¬ GFX Web æœåŠ¡å¯åŠ¨ä¸­...
============================================================
è®¿é—®: http://localhost:5000
API ç«¯ç‚¹:
  - GFX è½¬æ¢: http://localhost:5000/convert_ttf_to_gfx
  - ä½å›¾ä¿å­˜: http://localhost:5000/save_bitmap_font

åœ¨ web_layout.html ä¸­å¯ä»¥é€šè¿‡ fetch è°ƒç”¨æ­¤API
============================================================
 * Running on http://0.0.0.0:5000
```

### æ­¥éª¤ 2: æ‰“å¼€ç½‘é¡µ

æµè§ˆå™¨è®¿é—®:
```
http://ESP32_IP/web_layout.html
```

### æ­¥éª¤ 3: è½¬æ¢å­—ä½“

1. ä¸Šä¼  TTF å­—ä½“æ–‡ä»¶
2. è¾“å…¥æ–‡å­— (å¦‚: `æµ‹è¯•æ–‡å­—`)
3. é€‰æ‹©å­—å· (å¦‚: 24)
4. ç‚¹å‡» **"è½¬æ¢ä¸ºä½å›¾æ ¼å¼ (æ¨èä¸­æ–‡)"**

### æ­¥éª¤ 4: æŸ¥çœ‹ç»“æœ

**æˆåŠŸæ—¶æ˜¾ç¤º:**
```
âœ… ä½å›¾è½¬æ¢æˆåŠŸï¼
å­—ç¬¦æ•°: 4
å­—å·: 24pt
æ ¼å¼: ç‹¬ç«‹ä½å›¾æ•°ç»„ (æ—  Unicode èŒƒå›´é™åˆ¶)
æ–‡ä»¶: fangsong24pt_bitmaps.h
âœ… å·²ä¿å­˜åˆ°: G:\A_BL_Project\inkScree_fuben\components\fonts\fangsong24pt_bitmaps.h
```

**å¤±è´¥æ—¶æ˜¾ç¤º:**
```
âœ… ä½å›¾è½¬æ¢æˆåŠŸï¼
...
âš ï¸ æœ¬åœ°ä¿å­˜å¤±è´¥: Connection refused
ï¼ˆæ–‡ä»¶å·²ä¸‹è½½åˆ°æµè§ˆå™¨ï¼‰
```

---

## ğŸ”§ å·¥ä½œåŸç†

### å‰ç«¯ (web_layout.html)

#### 1. ç”¨æˆ·ç‚¹å‡»è½¬æ¢æŒ‰é’®
```javascript
convertTTFtoBitmap()
```

#### 2. åœ¨ Canvas ä¸Šç»˜åˆ¶å­—ç¬¦
```javascript
ctx.fillText(char, 0, 0);
const imageData = ctx.getImageData(0, 0, width, height);
```

#### 3. è½¬æ¢ä¸ºä½å›¾æ•°æ®
```javascript
for (let y = 0; y < height; y++) {
    for (let x = 0; x < width; x += 8) {
        let byte = 0;
        for (let bit = 0; bit < 8 && (x + bit) < width; bit++) {
            if (pixels[idx] < 128) {
                byte |= (0x80 >> bit);
            }
        }
        bitmap.push(byte);
    }
}
```

#### 4. ç”Ÿæˆ .h æ–‡ä»¶
```javascript
const headerContent = generateBitmapHeader(bitmapData, fontSize);
```

#### 5. åŒé‡ä¿å­˜
```javascript
// æµè§ˆå™¨ä¸‹è½½
downloadGFXHeader(headerContent, filename);

// æœ¬åœ°ä¿å­˜
saveBitmapToLocal(headerContent, filename);
```

### åç«¯ (ttf_to_gfx_webservice.py)

#### æ¥æ”¶è¯·æ±‚
```python
@app.route('/save_bitmap_font', methods=['POST'])
def save_bitmap_font():
    data = request.json
    content = data.get('content', '')
    filename = data.get('filename', 'bitmap_font.h')
```

#### ç¡®å®šä¿å­˜è·¯å¾„
```python
script_dir = os.path.dirname(os.path.abspath(__file__))
project_root = os.path.dirname(script_dir)
fonts_dir = os.path.join(project_root, 'components', 'fonts')
```

**è·¯å¾„ç¤ºä¾‹:**
- `script_dir`: `G:\A_BL_Project\inkScree_fuben\tools`
- `project_root`: `G:\A_BL_Project\inkScree_fuben`
- `fonts_dir`: `G:\A_BL_Project\inkScree_fuben\components\fonts`

#### ä¿å­˜æ–‡ä»¶
```python
os.makedirs(fonts_dir, exist_ok=True)
file_path = os.path.join(fonts_dir, filename)
with open(file_path, 'w', encoding='utf-8') as f:
    f.write(content)
```

#### è¿”å›ç»“æœ
```python
return jsonify({
    'success': True,
    'message': 'æ–‡ä»¶ä¿å­˜æˆåŠŸ',
    'saved_path': file_path,
    'filename': filename
})
```

---

## ğŸ“‚ æ–‡ä»¶ç»“æ„

ä¿å­˜åçš„ç›®å½•ç»“æ„:

```
inkScree_fuben/
â”œâ”€â”€ components/
â”‚   â””â”€â”€ fonts/
â”‚       â”œâ”€â”€ fangsong16pt_bitmaps.h  â† è‡ªåŠ¨ä¿å­˜
â”‚       â”œâ”€â”€ fangsong20pt_bitmaps.h  â† è‡ªåŠ¨ä¿å­˜
â”‚       â”œâ”€â”€ fangsong24pt_bitmaps.h  â† è‡ªåŠ¨ä¿å­˜
â”‚       â””â”€â”€ ...
â”œâ”€â”€ tools/
â”‚   â”œâ”€â”€ ttf_to_gfx_webservice.py    â† åç«¯æœåŠ¡
â”‚   â””â”€â”€ test_bitmap_save.py         â† æµ‹è¯•è„šæœ¬
â””â”€â”€ ...
```

---

## ğŸ§ª æµ‹è¯•

### æ–¹æ³• 1: ä½¿ç”¨æµ‹è¯•è„šæœ¬

```powershell
python tools/test_bitmap_save.py
```

**è¾“å‡º:**
```
============================================================
æµ‹è¯•ä½å›¾å­—ä½“ä¿å­˜åŠŸèƒ½
============================================================

1. æ£€æŸ¥æœåŠ¡çŠ¶æ€...
   âœ… æœåŠ¡æ­£å¸¸: running

2. ä¿å­˜æ–‡ä»¶: test_bitmap_24pt.h
   âœ… ä¿å­˜æˆåŠŸ!
   è·¯å¾„: G:\A_BL_Project\inkScree_fuben\components\fonts\test_bitmap_24pt.h
   æ–‡ä»¶å: test_bitmap_24pt.h

============================================================
æµ‹è¯•å®Œæˆ
============================================================
```

### æ–¹æ³• 2: ä½¿ç”¨ curl æµ‹è¯•

```powershell
$body = @{
    content = "// Test content"
    filename = "test.h"
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:5000/save_bitmap_font" `
    -Method POST `
    -ContentType "application/json" `
    -Body $body
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. Python æœåŠ¡å¿…é¡»è¿è¡Œ

å¦‚æœæœåŠ¡æœªå¯åŠ¨,ä¼šæ˜¾ç¤º:
```
âš ï¸ æœ¬åœ°ä¿å­˜å¤±è´¥: Connection refused
ï¼ˆæ–‡ä»¶å·²ä¸‹è½½åˆ°æµè§ˆå™¨ï¼‰
```

**è§£å†³**: å¯åŠ¨æœåŠ¡
```powershell
python tools/ttf_to_gfx_webservice.py
```

### 2. ç«¯å£å†²çª

å¦‚æœ 5000 ç«¯å£è¢«å ç”¨:

**ä¿®æ”¹ç«¯å£** (ttf_to_gfx_webservice.py):
```python
app.run(host='0.0.0.0', port=5001, debug=True)
```

**åŒæ—¶ä¿®æ”¹å‰ç«¯** (web_layout.html):
```javascript
const response = await fetch('http://localhost:5001/save_bitmap_font', {
```

### 3. æ–‡ä»¶æƒé™

ç¡®ä¿æœ‰å†™å…¥æƒé™:
```powershell
# Windows
icacls "components\fonts" /grant Users:F

# Linux/Mac
chmod 755 components/fonts
```

### 4. æ–‡ä»¶è¦†ç›–

å¦‚æœæ–‡ä»¶å·²å­˜åœ¨,ä¼š**è‡ªåŠ¨è¦†ç›–**ã€‚å»ºè®®å¤‡ä»½é‡è¦æ–‡ä»¶ã€‚

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: æç¤º "Connection refused"

**åŸå› **: Python æœåŠ¡æœªè¿è¡Œ

**è§£å†³**:
```powershell
python tools/ttf_to_gfx_webservice.py
```

---

### é—®é¢˜ 2: ä¿å­˜æˆåŠŸä½†æ‰¾ä¸åˆ°æ–‡ä»¶

**åŸå› **: è·¯å¾„è®¡ç®—é”™è¯¯

**æ£€æŸ¥**:
1. æŸ¥çœ‹è¿”å›çš„ `saved_path`
2. ç¡®è®¤ `components/fonts/` ç›®å½•å­˜åœ¨
3. æ£€æŸ¥ Python è„šæœ¬çš„å½“å‰å·¥ä½œç›®å½•

**è°ƒè¯•**:
```python
print(f"Script dir: {script_dir}")
print(f"Project root: {project_root}")
print(f"Fonts dir: {fonts_dir}")
```

---

### é—®é¢˜ 3: æ–‡ä»¶å†…å®¹ä¹±ç 

**åŸå› **: ç¼–ç é—®é¢˜

**è§£å†³**: ç¡®ä¿ä½¿ç”¨ UTF-8 ç¼–ç 
```python
with open(file_path, 'w', encoding='utf-8') as f:
    f.write(content)
```

---

### é—®é¢˜ 4: CORS é”™è¯¯

**åŸå› **: è·¨åŸŸè¯·æ±‚è¢«é˜»æ­¢

**è§£å†³**: ç¡®ä¿ Flask-CORS å·²å®‰è£…
```powershell
pip install flask-cors
```

---

## ğŸ“Š å®Œæ•´å·¥ä½œæµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·ä¸Šä¼  TTF    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é¢„è§ˆå¹¶è®¾ç½®å‚æ•°  â”‚
â”‚  - å­—å·         â”‚
â”‚  - æ–‡å­—         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç‚¹å‡» "è½¬æ¢ä¸ºä½å›¾æ ¼å¼"            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯: Canvas ç»˜åˆ¶ â†’ åƒç´ æå–    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”Ÿæˆ .h æ–‡ä»¶å†…å®¹                â”‚
â”‚  - BITMAP_XXXX[] æ•°ç»„            â”‚
â”‚  - drawXXXChar() å‡½æ•°            â”‚
â”‚  - drawXXXString() å‡½æ•°          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                             â”‚
         â–¼                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æµè§ˆå™¨ä¸‹è½½      â”‚         â”‚  å‘é€åˆ°åç«¯      â”‚
â”‚  â†“ Downloads/   â”‚         â”‚  POST /save...  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚  åç«¯ä¿å­˜        â”‚
                            â”‚  â†“ fonts/       â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚  è¿”å›ä¿å­˜è·¯å¾„    â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚  æ›´æ–°çŠ¶æ€æ˜¾ç¤º    â”‚
                            â”‚  âœ… å·²ä¿å­˜åˆ°...  â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: ç”ŸæˆçŠ¶æ€å­—ä½“

```javascript
// 1. ä¸Šä¼ ä»¿å®‹å­—ä½“
// 2. è¾“å…¥: "æ­£å¸¸è¿è¡Œé”™è¯¯è­¦å‘Šå®Œæˆ"
// 3. å­—å·: 20
// 4. ç‚¹å‡»è½¬æ¢
```

**ç»“æœ:**
- æµè§ˆå™¨ä¸‹è½½: `fangsong20pt_bitmaps.h`
- æœ¬åœ°ä¿å­˜: `components/fonts/fangsong20pt_bitmaps.h`

**ä½¿ç”¨:**
```cpp
#include "../fonts/fangsong20pt_bitmaps.h"

drawFangsong20ptString(display, 10, 50, "è¿è¡Œæ­£å¸¸");
```

---

### ç¤ºä¾‹ 2: ç”Ÿæˆæ¸©åº¦å­—ä½“

```javascript
// è¾“å…¥: "æ¸©åº¦æ¹¿â„ƒ%0123456789:"
// å­—å·: 16
```

**ä½¿ç”¨:**
```cpp
char temp_str[32];
sprintf(temp_str, "æ¸©åº¦:%dâ„ƒ", 25);
drawFangsong16ptString(display, 10, 30, temp_str);
```

---

## âœ… ä¼˜åŠ¿æ€»ç»“

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **åŒé‡ä¿å­˜** | æµè§ˆå™¨ + æœ¬åœ°,æ›´å®‰å…¨ |
| **è‡ªåŠ¨è·¯å¾„** | æ— éœ€æ‰‹åŠ¨å¤åˆ¶ç²˜è´´ |
| **å®æ—¶åé¦ˆ** | æ˜¾ç¤ºä¿å­˜è·¯å¾„å’ŒçŠ¶æ€ |
| **å®¹é”™å¤„ç†** | ä¿å­˜å¤±è´¥ä»å¯ä¸‹è½½ |
| **UTF-8 ç¼–ç ** | æ”¯æŒä¸­æ–‡è·¯å¾„å’Œå†…å®¹ |

---

**æ›´æ–°æ—¶é—´**: 2025-12-12  
**ç›¸å…³æ–‡æ¡£**: `TTFå­—ä½“ä½å›¾è½¬æ¢ä½¿ç”¨æŒ‡å—.md`
