// é¦–å…ˆï¼Œåœ¨CSSä¸­æ·»åŠ ç©ºå¿ƒçŸ©å½¢çš„æ ·å¼
const char* WEB_LAYOUT_HTML = R"rawliteral(
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¢¨æ°´å±å¸ƒå±€ç¼–è¾‘å™¨</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            display: flex;
            flex-wrap: wrap;
            padding: 20px;
            gap: 20px;
        }

        .preview-section {
            flex: 1;
            min-width: 400px;
        }

        .controls-section {
            flex: 1;
            min-width: 300px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }

        .screen-container {
            width: 416px;
            height: 240px;
            border: 3px solid #333;
            background: #fff;
            position: relative;
            margin: 20px auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            user-select: none;
            /* é˜²æ­¢æ‹–åŠ¨æ—¶é€‰ä¸­æ–‡å­— */
        }

        .rect {
            position: absolute;
            border: 2px solid #4CAF50;
            background: rgba(76, 175, 80, 0.1);
            cursor: move;
            transition: all 0.3s;
            z-index: 10;
        }

        .rect:hover {
            border-color: #2196F3;
            background: rgba(33, 150, 243, 0.2);
            z-index: 15;
        }

        .rect.selected {
            border-color: #FF9800;
            border-width: 3px;
            background: rgba(255, 152, 0, 0.3);
            box-shadow: 0 0 15px rgba(255, 152, 0, 0.6);
            z-index: 20;
        }

        /* æ‹–æ‹½ç›®æ ‡çŸ©å½¢é«˜äº®æ ·å¼ */
        .rect.drop-target {
            border-color: #9C27B0;
            border-width: 3px;
            border-style: dashed;
            background: rgba(156, 39, 176, 0.2);
            box-shadow: 0 0 20px rgba(156, 39, 176, 0.4) inset;
            z-index: 18;
        }

        /* è°ƒæ•´å¤§å°çš„æ‰‹æŸ„æ ·å¼ */
        .resize-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: #fff;
            border: 2px solid #2196F3;
            border-radius: 50%;
            z-index: 101;
            display: none; /* é»˜è®¤éšè— */
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .rect:hover .resize-handle, .rect.selected .resize-handle {
            display: block;
        }

        .resize-handle.se {
            bottom: -6px;
            right: -6px;
            cursor: se-resize;
        }
        
        .resize-handle.e {
            top: 50%;
            right: -6px;
            transform: translateY(-50%);
            cursor: e-resize;
        }
        
        .resize-handle.s {
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            cursor: s-resize;
        }

        .resize-handle:hover {
            background-color: #2196F3;
            transform: scale(1.2);
        }
        
        .resize-handle.e:hover {
            transform: translateY(-50%) scale(1.2);
        }
        
        .resize-handle.s:hover {
            transform: translateX(-50%) scale(1.2);
        }


        /* æ–°çš„ç©ºå¿ƒçŸ©å½¢æ ·å¼ */
        .icon-hollow-rect {
            position: absolute;
            border: 2px solid #FF5722;
            background: rgba(255, 255, 255, 0.01); /* å¢åŠ ç‚¹å‡»åŒºåŸŸ */
            box-sizing: border-box;
            cursor: grab;
            transition: transform 0.1s, box-shadow 0.1s, border-color 0.1s;
            z-index: 50;
            border-radius: 4px;
        }

        .icon-hollow-rect:active {
            cursor: grabbing;
        }

        .icon-hollow-rect:hover {
            border-color: #E91E63;
            background: rgba(233, 30, 99, 0.1);
            transform: scale(1.02);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 60;
        }

        .icon-hollow-rect.selected {
            border-color: #2196F3;
            border-width: 3px;
            background: rgba(33, 150, 243, 0.2);
            box-shadow: 0 0 0 2px white, 0 0 10px #2196F3;
            z-index: 55;
        }

        .icon-hollow-rect.dragging {
            border-color: #9C27B0;
            background: rgba(156, 39, 176, 0.3);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
            transform: scale(1.1);
            opacity: 0.9;
            z-index: 100; /* æ‹–æ‹½æ—¶æœ€é«˜ */
        }

        /* åˆ é™¤æŒ‰é’®æ ·å¼ */
        .delete-btn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 5px;
            transition: background 0.3s;
        }

        .delete-btn:hover {
            background-color: #d32f2f;
        }

        /* å›¾æ ‡æ ‡ç­¾æ ·å¼ */
        .icon-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10px;
            font-weight: bold;
            color: #FF5722;
            text-align: center;
            pointer-events: none;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
        }

        .icon-hollow-rect:hover .icon-label {
            color: #E91E63;
        }

        .icon-hollow-rect.selected .icon-label {
            color: #2196F3;
        }

        .icon-hollow-rect.dragging .icon-label {
            color: #9C27B0;
        }

        .control-group {
            margin-bottom: 25px;
        }

        .control-group h3 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 600;
        }

        input[type="number"],
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="number"]:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #c62828 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
        }

        .status-message {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .rect-info {
            background: white;
            border-radius: 5px;
            padding: 15px;
            margin-top: 10px;
            border: 1px solid #ddd;
        }

        .rect-id {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
        }

        .grid-lines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .grid-line {
            position: absolute;
            background: rgba(0, 0, 0, 0.05);
        }

        .grid-line.vertical {
            width: 1px;
            height: 100%;
        }

        .grid-line.horizontal {
            height: 1px;
            width: 100%;
        }

        /* å¯¹é½è¾…åŠ©çº¿ */
        .alignment-guide {
            position: absolute;
            z-index: 200;
            pointer-events: none;
        }

        .alignment-guide.vertical {
            width: 2px;
            background: #2196F3;
            height: 100%;
        }

        .alignment-guide.horizontal {
            height: 2px;
            background: #2196F3;
            width: 100%;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }

            .screen-container {
                width: 100%;
                max-width: 416px;
                height: 240px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>å¢¨æ°´å±å¸ƒå±€ç¼–è¾‘å™¨</h1>
            <p class="subtitle">å¯è§†åŒ–ç¼–è¾‘å¢¨æ°´å±çŸ©å½¢å’Œå›¾æ ‡å¸ƒå±€</p>
        </header>

        <div class="main-content">
            <div class="preview-section">
                <div class="screen-container" id="screenContainer">
                    <!-- ç½‘æ ¼çº¿ -->
                    <div class="grid-lines" id="gridLines"></div>
                    <!-- å¯¹é½è¾…åŠ©çº¿ -->
                    <div id="alignmentGuides"></div>
                    <!-- çŸ©å½¢å’Œå›¾æ ‡ä¼šåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <p>å±å¹•å°ºå¯¸: <span id="screenSize">416Ã—240</span></p>
                    <p>å½“å‰çŸ©å½¢æ•°: <span id="rectCount">0</span></p>
                    <p>å½“å‰å›¾æ ‡æ•°: <span id="iconCount">0</span></p>
                </div>
            </div>

            <div class="controls-section">
                <div class="control-group">
                    <h3>ğŸ“± å±å¹•è®¾ç½®</h3>
                    <div class="form-group">
                        <label>å±å¹•å®½åº¦ (px)</label>
                        <input type="number" id="screenWidth" value="416" min="100" max="800">
                    </div>
                    <div class="form-group">
                        <label>å±å¹•é«˜åº¦ (px)</label>
                        <input type="number" id="screenHeight" value="240" min="100" max="600">
                    </div>
                    <button class="btn" onclick="updateScreenSize()">æ›´æ–°å±å¹•å°ºå¯¸</button>
                </div>

                <div class="control-group">
                    <h3>ğŸ“ çŸ©å½¢æ“ä½œ</h3>
                    <div class="rect-info" id="selectedRectInfo">
                        æœªé€‰ä¸­ä»»ä½•çŸ©å½¢
                    </div>
                    <div class="form-group">
                        <label>çŸ©å½¢å®½åº¦ (px)</label>
                        <input type="number" id="rectWidth" value="138" min="10" max="416">
                    </div>
                    <div class="form-group">
                        <label>çŸ©å½¢é«˜åº¦ (px)</label>
                        <input type="number" id="rectHeight" value="100" min="10" max="240">
                    </div>
                    <button class="btn" onclick="addRectangle()">æ·»åŠ æ–°çŸ©å½¢</button>
                    <button class="btn btn-warning" onclick="removeSelectedRect()">åˆ é™¤é€‰ä¸­çŸ©å½¢</button>
                    <button class="btn btn-danger" onclick="clearAllRectangles()">æ¸…ç©ºæ‰€æœ‰çŸ©å½¢</button>
                </div>

                <div class="control-group">
                    <h3>ğŸ¯ å›¾æ ‡æ“ä½œ</h3>
                    <div class="form-group">
                        <label>å›¾æ ‡ç´¢å¼• (0-5)</label>
                        <input type="number" id="iconIndex" value="0" min="0" max="5">
                    </div>
                    <div class="form-group">
                        <label>å›¾æ ‡å®½åº¦ (px)</label>
                        <input type="number" id="iconWidth" value="30" min="10" max="100">
                    </div>
                    <div class="form-group">
                        <label>å›¾æ ‡é«˜åº¦ (px)</label>
                        <input type="number" id="iconHeight" value="30" min="10" max="100">
                    </div>
                    <button class="btn" onclick="addIconToSelectedRect()">æ·»åŠ å›¾æ ‡åˆ°é€‰ä¸­çŸ©å½¢</button>
                    <button class="btn btn-warning" onclick="removeSelectedIcon()">åˆ é™¤é€‰ä¸­å›¾æ ‡</button>
                    <button class="btn" onclick="autoArrangeIcons()">è‡ªåŠ¨æ’åˆ—å›¾æ ‡</button>
                    <button class="btn btn-success" onclick="updateSelectedIconSize()">æ›´æ–°é€‰ä¸­å›¾æ ‡å°ºå¯¸</button>
                </div>

                <div class="control-group">
                    <h3>ğŸ’¾ å¸ƒå±€ç®¡ç†</h3>
                    <div class="status-message" id="statusMessage"></div>
                    <button class="btn" onclick="testLayoutData()">æµ‹è¯•æ•°æ®æ ¼å¼</button>
                    <button class="btn btn-success" onclick="getCurrentLayout()">è·å–å½“å‰å¸ƒå±€</button>
                    <button class="btn btn-success" onclick="applyToDevice()">åº”ç”¨åˆ°è®¾å¤‡</button>
                    <button class="btn" onclick="saveLayoutToFile()">ä¿å­˜åˆ°æ–‡ä»¶</button>
                    <button class="btn" onclick="loadLayoutFromFile()">ä»æ–‡ä»¶åŠ è½½</button>
                    <button class="btn btn-warning" onclick="resetToDefault()">é‡ç½®ä¸ºé»˜è®¤å¸ƒå±€</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentLayout = {
            screen: { width: 416, height: 240 },
            rectangles: [],
            status_rect_index: 0
        };

        let selectedRectIndex = -1;
        let selectedIconIndex = -1;
        let draggedIconElement = null;
        let currentDropTargetIndex = -1; // å½“å‰æ‹–æ‹½ç›®æ ‡çŸ©å½¢ç´¢å¼•


        // åˆå§‹åŒ–
        function init() {
            drawGridLines();
            // è®¾ç½®é»˜è®¤å¸ƒå±€ä½†ä¸ç«‹å³æ¸²æŸ“
            //setDefaultLayout();
            // ç„¶åå°è¯•ä»è®¾å¤‡è·å–å¸ƒå±€
            getCurrentLayoutFromDevice();
        }

        // æ·»åŠ ä¸€ä¸ªè®¾ç½®é»˜è®¤å¸ƒå±€ä½†ä¸æ¸²æŸ“çš„å‡½æ•°
        function setDefaultLayout() {
            currentLayout = {
                screen: { width: 416, height: 240 },
                rectangles: [],
                status_rect_index: 0
            };

            // æ·»åŠ é»˜è®¤çŸ©å½¢
            const defaultRects = [
                { x: 0, y: 0, width: 416, height: 36, icon_count: 0, icons: [] },
                {
                    x: 0, y: 40, width: 138, height: 100, icon_count: 3, icons: [
                        { icon_index: 0, rel_x: 0.25, rel_y: 0.25, original_width: 30, original_height: 30 },
                        { icon_index: 1, rel_x: 0.75, rel_y: 0.25, original_width: 30, original_height: 30 },
                        { icon_index: 2, rel_x: 0.5, rel_y: 0.75, original_width: 30, original_height: 30 }
                    ]
                },
                {
                    x: 142, y: 40, width: 132, height: 100, icon_count: 2, icons: [
                        { icon_index: 3, rel_x: 0.3, rel_y: 0.3, original_width: 30, original_height: 30 },
                        { icon_index: 4, rel_x: 0.7, rel_y: 0.7, original_width: 30, original_height: 30 }
                    ]
                },
                {
                    x: 278, y: 40, width: 138, height: 100, icon_count: 2, icons: [
                        { icon_index: 5, rel_x: 0.25, rel_y: 0.5, original_width: 30, original_height: 30 },
                        { icon_index: 0, rel_x: 0.75, rel_y: 0.5, original_width: 30, original_height: 30 }
                    ]
                },
                {
                    x: 0, y: 144, width: 138, height: 96, icon_count: 4, icons: [
                        { icon_index: 1, rel_x: 0.2, rel_y: 0.3, original_width: 30, original_height: 30 },
                        { icon_index: 2, rel_x: 0.5, rel_y: 0.3, original_width: 30, original_height: 30 },
                        { icon_index: 3, rel_x: 0.8, rel_y: 0.3, original_width: 30, original_height: 30 },
                        { icon_index: 4, rel_x: 0.5, rel_y: 0.7, original_width: 30, original_height: 30 }
                    ]
                },
                {
                    x: 142, y: 144, width: 132, height: 96, icon_count: 3, icons: [
                        { icon_index: 5, rel_x: 0.5, rel_y: 0.25, original_width: 30, original_height: 30 },
                        { icon_index: 0, rel_x: 0.3, rel_y: 0.75, original_width: 30, original_height: 30 },
                        { icon_index: 1, rel_x: 0.7, rel_y: 0.75, original_width: 30, original_height: 30 }
                    ]
                },
                {
                    x: 278, y: 144, width: 138, height: 96, icon_count: 1, icons: [
                        { icon_index: 2, rel_x: 0.5, rel_y: 0.5, original_width: 30, original_height: 30 }
                    ]
                }
            ];

            defaultRects.forEach((rect, index) => {
                currentLayout.rectangles.push({
                    ...rect,
                    original_x: rect.x,
                    original_y: rect.y,
                    original_width: rect.width,
                    original_height: rect.height,
                    is_status_bar: index === 0
                });
            });
        }

        // ç»˜åˆ¶ç½‘æ ¼çº¿
        function drawGridLines() {
            const gridLines = document.getElementById('gridLines');
            if (!gridLines) {
                console.warn('gridLines å…ƒç´ ä¸å­˜åœ¨');
                return;
            }

            // æ¸…ç©ºä¹‹å‰çš„ç½‘æ ¼çº¿
            gridLines.innerHTML = '';

            const gridSize = 20;
            const screenWidth = currentLayout.screen.width || 416;
            const screenHeight = currentLayout.screen.height || 240;

            // å‚ç›´çº¿
            for (let x = gridSize; x < screenWidth; x += gridSize) {
                const line = document.createElement('div');
                line.className = 'grid-line vertical';
                line.style.position = 'absolute';
                line.style.left = x + 'px';
                line.style.top = '0';
                line.style.width = '1px';
                line.style.height = '100%';
                line.style.backgroundColor = 'rgba(0, 0, 0, 0.05)';
                line.style.pointerEvents = 'none';
                gridLines.appendChild(line);
            }

            // æ°´å¹³çº¿
            for (let y = gridSize; y < screenHeight; y += gridSize) {
                const line = document.createElement('div');
                line.className = 'grid-line horizontal';
                line.style.position = 'absolute';
                line.style.left = '0';
                line.style.top = y + 'px';
                line.style.width = '100%';
                line.style.height = '1px';
                line.style.backgroundColor = 'rgba(0, 0, 0, 0.05)';
                line.style.pointerEvents = 'none';
                gridLines.appendChild(line);
            }
        }

        // ä»è®¾å¤‡è·å–å½“å‰å¸ƒå±€
        async function getCurrentLayoutFromDevice() {
            console.log('å¼€å§‹è·å–å¸ƒå±€æ•°æ®...');

            try {
                const response = await fetch('/getlayout');
                console.log('HTTPå“åº”çŠ¶æ€:', response.status, response.statusText);

                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('è·å–åˆ°JSONæ•°æ®:', data);

                // æ•°æ®éªŒè¯
                if (!data) {
                    throw new Error('æœåŠ¡å™¨è¿”å›ç©ºæ•°æ®');
                }

                // ç¡®ä¿æ•°æ®æ ¼å¼æ­£ç¡®
                if (!data.rectangles || !Array.isArray(data.rectangles)) {
                    console.warn('rectangles ä¸æ˜¯æ•°ç»„æˆ–ä¸å­˜åœ¨ï¼Œå°è¯•ä¿®å¤...');
                    data.rectangles = [];
                }

                // å­˜å‚¨ä»è®¾å¤‡è·å–çš„å›¾æ ‡å°ºå¯¸
                if (data.rectangles && Array.isArray(data.rectangles)) {
                    data.rectangles.forEach((rect, rectIndex) => {
                        if (rect.icons && Array.isArray(rect.icons)) {
                            rect.icons.forEach((icon, iconIndex) => {
                                // è®°å½•å›¾æ ‡å°ºå¯¸
                                console.log(`çŸ©å½¢ ${rectIndex} å›¾æ ‡ ${iconIndex}: å°ºå¯¸=${icon.display_width || 30}x${icon.display_height || 30}`);
                            });
                        }
                    });
                }

                // è°ƒç”¨ renderLayout å¹¶ä¼ é€’æ•°æ®
                renderLayout(data);
                return data;

            } catch (error) {
                console.error('è·å–å¸ƒå±€å¤±è´¥:', error);
                showStatus('è·å–å¸ƒå±€å¤±è´¥: ' + error.message, 'error');
                return null;
            }
        }

        function renderLayout(layout) {
            console.log('renderLayout æ¥æ”¶åˆ°æ•°æ®:', layout);

            try {
                if (!layout) {
                    throw new Error('å¸ƒå±€æ•°æ®ä¸ºç©º');
                }

                const container = document.getElementById('screenContainer');
                if (!container) {
                    throw new Error('screenContainer å…ƒç´ ä¸å­˜åœ¨');
                }

                // æ¸…ç©ºå®¹å™¨å†…å®¹ï¼ˆé™¤äº†ç½‘æ ¼çº¿å’Œå¯¹é½è¾…åŠ©çº¿ï¼‰
                const children = Array.from(container.children);
                children.forEach(child => {
                    if (child.id !== 'gridLines' && child.id !== 'alignmentGuides') {
                        container.removeChild(child);
                    }
                });

                // éªŒè¯å±å¹•å°ºå¯¸
                const screenWidth = layout.screen_width || 416;
                const screenHeight = layout.screen_height || 240;

                console.log(`å±å¹•å°ºå¯¸: ${screenWidth}x${screenHeight}`);

                // æ›´æ–°å±å¹•å®¹å™¨çš„å°ºå¯¸
                container.style.width = screenWidth + 'px';
                container.style.height = screenHeight + 'px';

                // æ›´æ–°æ˜¾ç¤ºçš„å±å¹•å°ºå¯¸
                const screenSizeSpan = document.getElementById('screenSize');
                if (screenSizeSpan) {
                    screenSizeSpan.textContent = `${screenWidth}Ã—${screenHeight}`;
                }

                // æ›´æ–°å±å¹•è®¾ç½®è¾“å…¥æ¡†çš„å€¼
                const screenWidthInput = document.getElementById('screenWidth');
                const screenHeightInput = document.getElementById('screenHeight');
                if (screenWidthInput) screenWidthInput.value = screenWidth;
                if (screenHeightInput) screenHeightInput.value = screenHeight;

                // æ›´æ–° currentLayout çš„å±å¹•å°ºå¯¸
                currentLayout.screen.width = screenWidth;
                currentLayout.screen.height = screenHeight;

                // æ›´æ–° currentLayout çš„çŸ©å½¢æ•°æ®
                if (layout.rectangles && Array.isArray(layout.rectangles)) {
                    currentLayout.rectangles = layout.rectangles.map((rect, index) => {
                        if (!rect) return null;

                        const newRect = {
                            x: rect.x || 0,
                            y: rect.y || 0,
                            width: rect.width || 0,
                            height: rect.height || 0,
                            original_x: rect.original_x || rect.x || 0,
                            original_y: rect.original_y || rect.y || 0,
                            original_width: rect.original_width || rect.width || 0,
                            original_height: rect.original_height || rect.height || 0,
                            icon_count: rect.icon_count || (rect.icons ? rect.icons.length : 0),
                            icons: rect.icons || [],
                            is_status_bar: rect.is_status_bar || index === 0
                        };

                        // ç¡®ä¿æ¯ä¸ªå›¾æ ‡éƒ½æœ‰å®Œæ•´çš„æ•°æ®
                        if (newRect.icons && Array.isArray(newRect.icons)) {
                            newRect.icons.forEach((icon, iconIndex) => {
                                if (icon) {
                                    // ç¡®ä¿æœ‰æ˜¾ç¤ºä½ç½®å’Œå°ºå¯¸
                                    icon.display_x = icon.display_x || newRect.x + (newRect.width - (icon.display_width || 30)) * (icon.rel_x || 0.5);
                                    icon.display_y = icon.display_y || newRect.y + (newRect.height - (icon.display_height || 30)) * (icon.rel_y || 0.5);
                                    icon.display_width = icon.display_width || 30;
                                    icon.display_height = icon.display_height || 30;

                                    console.log(`çŸ©å½¢ ${index} å›¾æ ‡ ${iconIndex}: ä½ç½®(${icon.display_x},${icon.display_y}), å°ºå¯¸(${icon.display_width}x${icon.display_height})`);
                                }
                            });
                        }

                        return newRect;
                    }).filter(rect => rect !== null);
                } else {
                    currentLayout.rectangles = [];
                }

                // æ›´æ–°çŸ©å½¢å’Œå›¾æ ‡è®¡æ•°
                const rectCountSpan = document.getElementById('rectCount');
                const iconCountSpan = document.getElementById('iconCount');
                if (rectCountSpan) {
                    rectCountSpan.textContent = currentLayout.rectangles.length;
                }
                if (iconCountSpan) {
                    const totalIcons = currentLayout.rectangles.reduce((sum, rect) => sum + (rect.icons ? rect.icons.length : 0), 0);
                    iconCountSpan.textContent = totalIcons;
                }

                // ç»˜åˆ¶ç½‘æ ¼çº¿
                drawGridLines();

                // æ¸²æŸ“çŸ©å½¢
                if (currentLayout.rectangles && Array.isArray(currentLayout.rectangles)) {
                    console.log(`æ‰¾åˆ° ${currentLayout.rectangles.length} ä¸ªçŸ©å½¢`);

                    currentLayout.rectangles.forEach((rect, index) => {
                        try {
                            // éªŒè¯çŸ©å½¢æ•°æ®
                            if (!rect) {
                                console.warn(`çŸ©å½¢ ${index} æ•°æ®ä¸ºç©º`);
                                return;
                            }

                            // æ£€æŸ¥å¿…éœ€çš„å±æ€§
                            if (rect.x === undefined || rect.y === undefined || rect.width === undefined || rect.height === undefined) {
                                console.error(`çŸ©å½¢ ${index} ç¼ºå°‘å¿…éœ€å±æ€§:`, rect);
                                return;
                            }

                            console.log(`æ¸²æŸ“çŸ©å½¢ ${index}:`, {
                                x: rect.x,
                                y: rect.y,
                                width: rect.width,
                                height: rect.height,
                                icon_count: rect.icon_count
                            });

                            // åˆ›å»ºçŸ©å½¢å…ƒç´ 
                            const rectDiv = document.createElement('div');
                            rectDiv.className = 'rect';
                            rectDiv.dataset.index = index;
                            rectDiv.style.position = 'absolute';
                            rectDiv.style.left = rect.x + 'px';
                            rectDiv.style.top = rect.y + 'px';
                            rectDiv.style.width = rect.width + 'px';
                            rectDiv.style.height = rect.height + 'px';
                            rectDiv.style.border = '2px solid #4CAF50';
                            rectDiv.style.backgroundColor = rect.is_status_bar ?
                                'rgba(0, 100, 200, 0.2)' : 'rgba(76, 175, 80, 0.1)';
                            rectDiv.style.boxSizing = 'border-box';
                            rectDiv.style.cursor = 'move';

                            // ç‚¹å‡»äº‹ä»¶å°†ç”± makeDraggable å¤„ç†

                            // ä½¿çŸ©å½¢å¯æ‹–æ‹½
                            makeDraggable(rectDiv, index, 'rect');

                            // æ·»åŠ çŸ©å½¢ç¼–å·æ ‡ç­¾
                            const label = document.createElement('div');
                            label.textContent = `${index}`;
                            label.style.position = 'absolute';
                            label.style.top = '2px';
                            label.style.left = '2px';
                            label.style.fontSize = '10px';
                            label.style.fontWeight = 'bold';
                            label.style.color = rect.is_status_bar ? '#0066cc' : '#4CAF50';
                            rectDiv.appendChild(label);

                            // æ·»åŠ è°ƒæ•´å¤§å°çš„æ‰‹æŸ„
                            const handleSE = document.createElement('div');
                            handleSE.className = 'resize-handle se';
                            rectDiv.appendChild(handleSE);
                            makeResizable(rectDiv, handleSE, index, 'se');

                            const handleE = document.createElement('div');
                            handleE.className = 'resize-handle e';
                            rectDiv.appendChild(handleE);
                            makeResizable(rectDiv, handleE, index, 'e');

                            const handleS = document.createElement('div');
                            handleS.className = 'resize-handle s';
                            rectDiv.appendChild(handleS);
                            makeResizable(rectDiv, handleS, index, 's');

                            container.appendChild(rectDiv);

                            // æ¸²æŸ“å›¾æ ‡ - æ”¹ä¸ºä½¿ç”¨ç©ºå¿ƒçŸ©å½¢
                            if (rect.icons && Array.isArray(rect.icons)) {
                                rect.icons.forEach((icon, iconIndex) => {
                                    try {
                                        if (!icon) {
                                            console.warn(`çŸ©å½¢ ${index} çš„å›¾æ ‡ ${iconIndex} æ•°æ®ä¸ºç©º`);
                                            return;
                                        }

                                        // ä½¿ç”¨ä»è®¾å¤‡è·å–çš„å›¾æ ‡å°ºå¯¸
                                        const iconWidth = icon.display_width || 30;
                                        const iconHeight = icon.display_height || 30;
                                        const iconX = icon.display_x || rect.x + (rect.width - iconWidth) * (icon.rel_x || 0.5);
                                        const iconY = icon.display_y || rect.y + (rect.height - iconHeight) * (icon.rel_y || 0.5);

                                        console.log(`æ¸²æŸ“å›¾æ ‡ ${iconIndex}: ä½ç½®(${iconX},${iconY}), å°ºå¯¸(${iconWidth}x${iconHeight})`);

                                        // åˆ›å»ºç©ºå¿ƒçŸ©å½¢å›¾æ ‡
                                        const iconDiv = document.createElement('div');
                                        iconDiv.className = 'icon-hollow-rect';
                                        iconDiv.dataset.rectIndex = index;
                                        iconDiv.dataset.iconIndex = iconIndex;
                                        iconDiv.style.position = 'absolute';
                                        iconDiv.style.left = iconX + 'px';
                                        iconDiv.style.top = iconY + 'px';
                                        iconDiv.style.width = iconWidth + 'px';
                                        iconDiv.style.height = iconHeight + 'px';
                                        iconDiv.style.border = '2px solid #FF5722';
                                        iconDiv.style.borderRadius = '3px';
                                        iconDiv.style.backgroundColor = 'transparent';
                                        iconDiv.style.boxSizing = 'border-box';
                                        iconDiv.style.cursor = 'move';

                                        // ç‚¹å‡»äº‹ä»¶å°†ç”± makeDraggable å¤„ç†

                                        // æ·»åŠ æ‚¬åœæ•ˆæœ
                                        iconDiv.onmouseenter = () => {
                                            if (!iconDiv.classList.contains('dragging')) {
                                                iconDiv.style.borderColor = '#E91E63';
                                                iconDiv.style.backgroundColor = 'rgba(233, 30, 99, 0.1)';
                                            }
                                        };
                                        iconDiv.onmouseleave = () => {
                                            if (!iconDiv.classList.contains('dragging')) {
                                                iconDiv.style.borderColor = '#FF5722';
                                                iconDiv.style.backgroundColor = 'transparent';
                                            }
                                        };

                                        // æ·»åŠ å›¾æ ‡åºå·æ ‡ç­¾
                                        const iconLabel = document.createElement('div');
                                        iconLabel.className = 'icon-label';
                                        iconLabel.textContent = `${icon.icon_index !== undefined ? icon.icon_index : iconIndex}`;
                                        iconDiv.appendChild(iconLabel);

                                        // æ·»åŠ å°ºå¯¸æ ‡ç­¾
                                        const sizeLabel = document.createElement('div');
                                        sizeLabel.style.position = 'absolute';
                                        sizeLabel.style.bottom = '-15px';
                                        sizeLabel.style.left = '50%';
                                        sizeLabel.style.transform = 'translateX(-50%)';
                                        sizeLabel.style.fontSize = '8px';
                                        sizeLabel.style.color = '#666';
                                        sizeLabel.style.backgroundColor = 'rgba(255,255,255,0.8)';
                                        sizeLabel.style.padding = '1px 3px';
                                        sizeLabel.style.borderRadius = '2px';
                                        sizeLabel.style.display = 'none';
                                        sizeLabel.textContent = `${iconWidth}Ã—${iconHeight}`;
                                        iconDiv.appendChild(sizeLabel);

                                        // é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºå°ºå¯¸
                                        iconDiv.onmouseenter = () => {
                                            if (!iconDiv.classList.contains('dragging')) {
                                                iconDiv.style.borderColor = '#E91E63';
                                                iconDiv.style.backgroundColor = 'rgba(233, 30, 99, 0.1)';
                                                sizeLabel.style.display = 'block';
                                            }
                                        };
                                        iconDiv.onmouseleave = () => {
                                            if (!iconDiv.classList.contains('dragging')) {
                                                iconDiv.style.borderColor = '#FF5722';
                                                iconDiv.style.backgroundColor = 'transparent';
                                                sizeLabel.style.display = 'none';
                                            }
                                        };

                                        // ä½¿å›¾æ ‡å¯æ‹–æ‹½
                                        makeDraggable(iconDiv, iconIndex, 'icon', index);

                                        container.appendChild(iconDiv);

                                    } catch (iconError) {
                                        console.error(`æ¸²æŸ“å›¾æ ‡ ${iconIndex} å¤±è´¥:`, iconError);
                                    }
                                });
                            }

                        } catch (rectError) {
                            console.error(`æ¸²æŸ“çŸ©å½¢ ${index} å¤±è´¥:`, rectError);
                        }
                    });
                } else {
                    console.warn('æ²¡æœ‰æ‰¾åˆ°çŸ©å½¢æ•°æ®');
                }

                // æ¸…é™¤é€‰ä¸­çŠ¶æ€
                selectedRectIndex = -1;
                selectedIconIndex = -1;
                updateSelectedRectInfo();

                console.log('å¸ƒå±€æ¸²æŸ“å®Œæˆ');

            } catch (error) {
                console.error('æ¸²æŸ“å¸ƒå±€æ—¶å‘ç”Ÿé”™è¯¯:', error);
                showStatus('æ¸²æŸ“å¸ƒå±€æ—¶å‡ºé”™: ' + error.message, 'error');
            }
        }

        // æ£€æŸ¥çŸ©å½¢ç¢°æ’
        function checkRectCollision(targetRect, ignoreIndex) {
            for (let i = 0; i < currentLayout.rectangles.length; i++) {
                if (i === ignoreIndex) continue;
                const other = currentLayout.rectangles[i];
                
                // ç®€å•çš„AABBç¢°æ’æ£€æµ‹
                if (targetRect.x < other.x + other.width &&
                    targetRect.x + targetRect.width > other.x &&
                    targetRect.y < other.y + other.height &&
                    targetRect.y + targetRect.height > other.y) {
                    return true;
                }
            }
            return false;
        }

        // ä½¿å…ƒç´ å¯è°ƒæ•´å¤§å°
        function makeResizable(rectDiv, handle, index, direction) {
            let isResizing = false;
            let startX, startY, startWidth, startHeight;

            handle.onmousedown = function(e) {
                e.stopPropagation(); // é˜²æ­¢è§¦å‘æ‹–åŠ¨
                e.preventDefault();
                
                isResizing = true;
                startX = e.clientX;
                startY = e.clientY;
                startWidth = parseInt(rectDiv.style.width);
                startHeight = parseInt(rectDiv.style.height);
                
                // é€‰ä¸­å½“å‰çŸ©å½¢
                selectRectangle(index);

                document.onmousemove = function(e) {
                    if (!isResizing) return;

                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;
                    
                    let newWidth = startWidth;
                    let newHeight = startHeight;
                    
                    if (direction === 'se' || direction === 'e') {
                        newWidth = Math.max(10, startWidth + dx);
                    }
                    if (direction === 'se' || direction === 's') {
                        newHeight = Math.max(10, startHeight + dy);
                    }
                    
                    // é™åˆ¶åœ¨å±å¹•èŒƒå›´å†…
                    const screenWidth = currentLayout.screen.width;
                    const screenHeight = currentLayout.screen.height;
                    const currentX = parseInt(rectDiv.style.left);
                    const currentY = parseInt(rectDiv.style.top);
                    
                    newWidth = Math.min(newWidth, screenWidth - currentX);
                    newHeight = Math.min(newHeight, screenHeight - currentY);
                    
                    // ç¢°æ’æ£€æµ‹
                    const tempRect = {
                        x: currentX,
                        y: currentY,
                        width: newWidth,
                        height: newHeight
                    };
                    
                    if (!checkRectCollision(tempRect, index)) {
                        // å¦‚æœæ²¡æœ‰ç¢°æ’ï¼Œåº”ç”¨æ–°å°ºå¯¸
                        rectDiv.style.width = newWidth + 'px';
                        rectDiv.style.height = newHeight + 'px';
                        
                        // æ›´æ–°æ•°æ®
                        if (currentLayout.rectangles[index]) {
                            currentLayout.rectangles[index].width = newWidth;
                            currentLayout.rectangles[index].height = newHeight;
                            currentLayout.rectangles[index].original_width = newWidth;
                            currentLayout.rectangles[index].original_height = newHeight;
                            
                            // æ›´æ–°è¾“å…¥æ¡†
                            document.getElementById('rectWidth').value = newWidth;
                            document.getElementById('rectHeight').value = newHeight;
                            
                            // æ›´æ–°å›¾æ ‡ä½ç½®ï¼ˆä¿æŒç›¸å¯¹ä½ç½®ï¼‰
                            const rect = currentLayout.rectangles[index];
                            if (rect.icons && Array.isArray(rect.icons)) {
                                rect.icons.forEach((icon, iconIndex) => {
                                    // é‡æ–°è®¡ç®—ç»å¯¹ä½ç½®
                                    icon.display_x = rect.x + (newWidth - (icon.display_width || 30)) * (icon.rel_x || 0.5);
                                    icon.display_y = rect.y + (newHeight - (icon.display_height || 30)) * (icon.rel_y || 0.5);
                                    
                                    // æ›´æ–°DOM
                                    const iconDiv = document.querySelector(
                                        `.icon-hollow-rect[data-rect-index="${index}"][data-icon-index="${iconIndex}"]`
                                    );
                                    if (iconDiv) {
                                        iconDiv.style.left = icon.display_x + 'px';
                                        iconDiv.style.top = icon.display_y + 'px';
                                    }
                                });
                            }
                        }
                        
                        updateSelectedRectInfo();
                    }
                };

                document.onmouseup = function() {
                    isResizing = false;
                    document.onmousemove = null;
                    document.onmouseup = null;
                };
            };
        }

        // ä½¿å…ƒç´ å¯æ‹–æ‹½
        function makeDraggable(element, index, type, rectIndex = -1) {
            let isDragging = false;
            let startX, startY, initialLeft, initialTop;
            let originalIconPositions = []; // Store original icon positions for rect dragging

            element.onmousedown = function (e) {
                if (e.button !== 0) return; // åªå“åº”å·¦é”®
                // å¦‚æœç‚¹å‡»çš„æ˜¯resize handleï¼Œä¸è§¦å‘æ‹–åŠ¨
                if (e.target.classList.contains('resize-handle')) return;

                e.stopPropagation(); // é˜²æ­¢äº‹ä»¶å†’æ³¡

                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;

                const rect = element.getBoundingClientRect();
                initialLeft = parseInt(element.style.left) || 0;
                initialTop = parseInt(element.style.top) || 0;

                // è®¾ç½®æ‹–åŠ¨çŠ¶æ€
                if (type === 'icon') {
                    draggedIconElement = element;
                    element.classList.add('dragging');
                } else if (type === 'rect') {
                    // Store original icon positions
                    const rectData = currentLayout.rectangles[index];
                    if (rectData && rectData.icons && Array.isArray(rectData.icons)) {
                        originalIconPositions = rectData.icons.map(icon => ({
                            x: icon.display_x || 0,
                            y: icon.display_y || 0
                        }));
                    }
                }

                e.preventDefault();

                // æ¸…é™¤å¯¹é½è¾…åŠ©çº¿
                clearAlignmentGuides();

                document.onmousemove = function (e) {
                    if (!isDragging) return;

                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;

                    let newX = initialLeft + dx;
                    let newY = initialTop + dy;

                    // é™åˆ¶åœ¨å±å¹•èŒƒå›´å†…
                    const screenWidth = currentLayout.screen.width;
                    const screenHeight = currentLayout.screen.height;
                    const elementWidth = parseInt(element.style.width) || 0;
                    const elementHeight = parseInt(element.style.height) || 0;

                    newX = Math.max(0, Math.min(newX, screenWidth - elementWidth));
                    newY = Math.max(0, Math.min(newY, screenHeight - elementHeight));

                    // å¦‚æœæ‹–åŠ¨çš„æ˜¯å›¾æ ‡ï¼Œæ£€æŸ¥æ˜¯å¦ç§»åŠ¨åˆ°å…¶ä»–çŸ©å½¢ä¸­
                    if (type === 'icon') {
                        // æ£€æŸ¥å¯¹é½åˆ°å…¶ä»–å…ƒç´ 
                        const aligned = checkAlignment(newX, newY, elementWidth, elementHeight, type, rectIndex);
                        newX = aligned.x;
                        newY = aligned.y;

                        // è®¡ç®—å›¾æ ‡ä¸­å¿ƒç‚¹
                        const iconCenterX = newX + elementWidth / 2;
                        const iconCenterY = newY + elementHeight / 2;

                        // æŸ¥æ‰¾å›¾æ ‡ä¸­å¿ƒç‚¹æ‰€åœ¨çš„çŸ©å½¢
                        let hoveredRectIndex = -1;
                        for (let i = 0; i < currentLayout.rectangles.length; i++) {
                            const rect = currentLayout.rectangles[i];
                            if (iconCenterX >= rect.x && iconCenterX <= rect.x + rect.width &&
                                iconCenterY >= rect.y && iconCenterY <= rect.y + rect.height) {
                                hoveredRectIndex = i;
                                break;
                            }
                        }

                        // å¦‚æœä¸åœ¨ä»»ä½•çŸ©å½¢å†…ï¼Œæ‰¾åˆ°æœ€è¿‘çš„çŸ©å½¢å¹¶é«˜äº®
                        if (hoveredRectIndex === -1 && currentLayout.rectangles.length > 0) {
                            let minDistance = Infinity;
                            
                            for (let i = 0; i < currentLayout.rectangles.length; i++) {
                                const rect = currentLayout.rectangles[i];
                                const rectCenterX = rect.x + rect.width / 2;
                                const rectCenterY = rect.y + rect.height / 2;
                                const distance = Math.sqrt(
                                    Math.pow(iconCenterX - rectCenterX, 2) +
                                    Math.pow(iconCenterY - rectCenterY, 2)
                                );

                                if (distance < minDistance) {
                                    minDistance = distance;
                                    hoveredRectIndex = i;
                                }
                            }
                        }

                        // æ›´æ–°çŸ©å½¢é«˜äº®çŠ¶æ€
                        updateRectangleHighlight(hoveredRectIndex);

                        // æ›´æ–°å›¾æ ‡åœ¨çŸ©å½¢ä¸­çš„ç›¸å¯¹ä½ç½®
                        if (rectIndex >= 0 && currentLayout.rectangles[rectIndex]) {
                            const parentRect = currentLayout.rectangles[rectIndex];
                            const icon = parentRect.icons[index];

                            if (icon) {
                                // è®¡ç®—ç›¸å¯¹ä½ç½®
                                icon.display_x = newX;
                                icon.display_y = newY;
                                icon.rel_x = (newX - parentRect.x) / parentRect.width;
                                icon.rel_y = (newY - parentRect.y) / parentRect.height;
                            }
                        }
                    } else if (type === 'rect') {
                        // æ£€æŸ¥çŸ©å½¢å¯¹é½
                        const aligned = checkAlignment(newX, newY, elementWidth, elementHeight, type, index);
                        
                        // ç¢°æ’æ£€æµ‹ï¼šå¦‚æœæ–°ä½ç½®ä¼šå¯¼è‡´é‡å ï¼Œåˆ™ä¸å…è®¸ç§»åŠ¨
                        const tempRect = {
                            x: aligned.x,
                            y: aligned.y,
                            width: elementWidth,
                            height: elementHeight
                        };
                        
                        if (!checkRectCollision(tempRect, index)) {
                            newX = aligned.x;
                            newY = aligned.y;

                            // æ›´æ–°çŸ©å½¢æ•°æ®
                            if (currentLayout.rectangles[index]) {
                                currentLayout.rectangles[index].x = newX;
                                currentLayout.rectangles[index].y = newY;
                                currentLayout.rectangles[index].original_x = newX;
                                currentLayout.rectangles[index].original_y = newY;

                                // åŒæ—¶æ›´æ–°çŸ©å½¢å†…æ‰€æœ‰å›¾æ ‡çš„ä½ç½®
                                const rect = currentLayout.rectangles[index];
                                if (rect.icons && Array.isArray(rect.icons)) {
                                    const deltaX = newX - initialLeft;
                                    const deltaY = newY - initialTop;

                                    rect.icons.forEach((icon, iconIndex) => {
                                        if (originalIconPositions[iconIndex]) {
                                            icon.display_x = originalIconPositions[iconIndex].x + deltaX;
                                            icon.display_y = originalIconPositions[iconIndex].y + deltaY;
                                        }

                                        // æ›´æ–°å¯¹åº”çš„DOMå…ƒç´ 
                                        const iconDiv = document.querySelector(
                                            `.icon-hollow-rect[data-rect-index="${index}"][data-icon-index="${iconIndex}"]`
                                        );
                                        if (iconDiv) {
                                            iconDiv.style.left = icon.display_x + 'px';
                                            iconDiv.style.top = icon.display_y + 'px';
                                        }
                                    });
                                }
                            }
                        } else {
                            // å‘ç”Ÿç¢°æ’ï¼Œä¿æŒåŸä½ï¼ˆæˆ–è€…å¯ä»¥åšæ›´ç²¾ç»†çš„è´´è¾¹å¤„ç†ï¼Œè¿™é‡Œç®€å•å¤„ç†ä¸ºä¸ç§»åŠ¨ï¼‰
                            newX = parseInt(element.style.left);
                            newY = parseInt(element.style.top);
                        }
                    }

                    element.style.left = newX + 'px';
                    element.style.top = newY + 'px';

                    // æ›´æ–°é€‰ä¸­ä¿¡æ¯
                    updateSelectedRectInfo();
                };

                document.onmouseup = function (e) {
                    if (!isDragging) return;

                    // æ£€æµ‹ç‚¹å‡» (è·ç¦» < 5)
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;
                    if (Math.sqrt(dx * dx + dy * dy) < 5) {
                        if (type === 'icon') selectIcon(rectIndex, index);
                        else if (type === 'rect') selectRectangle(index);
                    }

                    isDragging = false;

                    // æ¸…é™¤æ‹–åŠ¨çŠ¶æ€
                    if (type === 'icon' && draggedIconElement) {
                        // è·å–å›¾æ ‡çš„æœ€ç»ˆä½ç½®
                        let iconX = parseInt(element.style.left);
                        let iconY = parseInt(element.style.top);
                        const iconWidth = parseInt(element.style.width);
                        const iconHeight = parseInt(element.style.height);
                        let iconCenterX = iconX + iconWidth / 2;
                        let iconCenterY = iconY + iconHeight / 2;

                        // 1. æŸ¥æ‰¾å›¾æ ‡ä¸­å¿ƒç‚¹æ‰€åœ¨çš„çŸ©å½¢
                        let targetRectIndex = -1;
                        for (let i = 0; i < currentLayout.rectangles.length; i++) {
                            const rect = currentLayout.rectangles[i];
                            if (iconCenterX >= rect.x && iconCenterX <= rect.x + rect.width &&
                                iconCenterY >= rect.y && iconCenterY <= rect.y + rect.height) {
                                targetRectIndex = i;
                                break;
                            }
                        }

                        // 2. å¦‚æœå›¾æ ‡ä¸åœ¨ä»»ä½•çŸ©å½¢å†…ï¼Œæ‰¾åˆ°æœ€è¿‘çš„çŸ©å½¢
                        if (targetRectIndex < 0 && currentLayout.rectangles.length > 0) {
                            let minDistance = Infinity;
                            let nearestRectIndex = -1;

                            for (let i = 0; i < currentLayout.rectangles.length; i++) {
                                const rect = currentLayout.rectangles[i];

                                // è®¡ç®—å›¾æ ‡ä¸­å¿ƒç‚¹åˆ°çŸ©å½¢ä¸­å¿ƒçš„è·ç¦»
                                const rectCenterX = rect.x + rect.width / 2;
                                const rectCenterY = rect.y + rect.height / 2;
                                const distance = Math.sqrt(
                                    Math.pow(iconCenterX - rectCenterX, 2) +
                                    Math.pow(iconCenterY - rectCenterY, 2)
                                );

                                if (distance < minDistance) {
                                    minDistance = distance;
                                    nearestRectIndex = i;
                                }
                            }

                            if (nearestRectIndex >= 0) {
                                targetRectIndex = nearestRectIndex;
                                console.log(`å›¾æ ‡ä¸åœ¨çŸ©å½¢å†…ï¼Œå¸é™„åˆ°æœ€è¿‘çš„çŸ©å½¢${targetRectIndex}`);
                            }
                        }

                        // 3. å¼ºåˆ¶é™åˆ¶å›¾æ ‡åœ¨ç›®æ ‡çŸ©å½¢èŒƒå›´å†…ï¼ˆé˜²æ­¢è·¨è¶Šè¾¹ç•Œï¼‰
                        if (targetRectIndex >= 0) {
                            const targetRect = currentLayout.rectangles[targetRectIndex];

                            // ä¸¥æ ¼é™åˆ¶åæ ‡åœ¨çŸ©å½¢å†…éƒ¨
                            const clampedX = Math.max(targetRect.x, Math.min(iconX, targetRect.x + targetRect.width - iconWidth));
                            const clampedY = Math.max(targetRect.y, Math.min(iconY, targetRect.y + targetRect.height - iconHeight));

                            // æ£€æŸ¥ä½ç½®æ˜¯å¦å‘ç”Ÿäº†ä¿®æ­£
                            if (clampedX !== iconX || clampedY !== iconY) {
                                iconX = clampedX;
                                iconY = clampedY;

                                // ç«‹å³æ›´æ–°DOMä½ç½®
                                element.style.left = iconX + 'px';
                                element.style.top = iconY + 'px';
                                console.log('å›¾æ ‡ä½ç½®å·²è‡ªåŠ¨ä¿®æ­£åˆ°çŸ©å½¢èŒƒå›´å†…');
                            }

                            // 4. æ›´æ–°æ•°æ®ç»“æ„
                            if (targetRectIndex !== rectIndex) {
                                // æƒ…å†µAï¼šç§»åŠ¨åˆ°äº†ä¸åŒçš„çŸ©å½¢
                                const sourceRect = currentLayout.rectangles[rectIndex];

                                // ä»åŸçŸ©å½¢ä¸­ç§»é™¤å›¾æ ‡
                                const iconData = sourceRect.icons.splice(index, 1)[0];
                                sourceRect.icon_count = sourceRect.icons.length;

                                // é‡æ–°è®¡ç®—å›¾æ ‡åœ¨æ–°çŸ©å½¢ä¸­çš„ç›¸å¯¹ä½ç½®
                                iconData.rel_x = (iconX - targetRect.x) / targetRect.width;
                                iconData.rel_y = (iconY - targetRect.y) / targetRect.height;
                                iconData.display_x = iconX;
                                iconData.display_y = iconY;

                                // æ·»åŠ åˆ°æ–°çŸ©å½¢
                                targetRect.icons.push(iconData);
                                targetRect.icon_count = targetRect.icons.length;

                                // æ›´æ–°DOMå…ƒç´ çš„data-rect-indexå±æ€§
                                element.dataset.rectIndex = targetRectIndex;

                                // æ›´æ–°é€‰ä¸­çŠ¶æ€
                                selectedRectIndex = targetRectIndex;
                                selectedIconIndex = targetRect.icons.length - 1;

                                console.log(`å›¾æ ‡ä»çŸ©å½¢${rectIndex}ç§»åŠ¨åˆ°çŸ©å½¢${targetRectIndex}`);
                            } else {
                                // æƒ…å†µBï¼šè¿˜åœ¨åŒä¸€ä¸ªçŸ©å½¢ï¼Œä½†ä½ç½®å¯èƒ½è¢«ä¿®æ­£äº†ï¼ˆå¸é™„è¾¹ç¼˜ï¼‰
                                // éœ€è¦æ›´æ–°å½“å‰å›¾æ ‡çš„æ•°æ®ï¼Œå› ä¸ºmousemoveåªæ›´æ–°äº†åŸå§‹çš„æ‹–æ‹½ä½ç½®
                                const iconData = currentLayout.rectangles[rectIndex].icons[index];
                                if (iconData) {
                                    iconData.display_x = iconX;
                                    iconData.display_y = iconY;
                                    iconData.rel_x = (iconX - targetRect.x) / targetRect.width;
                                    iconData.rel_y = (iconY - targetRect.y) / targetRect.height;
                                }
                            }

                            // æ›´æ–°é€‰ä¸­å›¾æ ‡ä¿¡æ¯æ˜¾ç¤º
                            updateSelectedRectInfo();
                        }

                        draggedIconElement.classList.remove('dragging');
                        draggedIconElement = null;

                        // æ¸…é™¤çŸ©å½¢é«˜äº®
                        updateRectangleHighlight(-1);
                    }

                    // æ¸…é™¤å¯¹é½è¾…åŠ©çº¿
                    clearAlignmentGuides();

                    document.onmousemove = null;
                    document.onmouseup = null;
                };
            };
        }

        // æ£€æŸ¥å¯¹é½
        function checkAlignment(x, y, width, height, type, index) {
            const threshold = 5; // å¯¹é½é˜ˆå€¼
            let showVerticalGuide = false;
            let showHorizontalGuide = false;
            let guideX = 0;
            let guideY = 0;

            // æ£€æŸ¥å¯¹é½åˆ°å…¶ä»–çŸ©å½¢
            currentLayout.rectangles.forEach((rect, rectIndex) => {
                if (type === 'rect' && rectIndex === index) return; // è·³è¿‡è‡ªå·±

                // å¯¹é½åˆ°çŸ©å½¢çš„å·¦è¾¹ç¼˜
                if (Math.abs(x - rect.x) < threshold) {
                    showVerticalGuide = true;
                    guideX = rect.x;
                    x = rect.x; // å¯¹é½åˆ°è¯¥ä½ç½®
                }
                // å¯¹é½åˆ°çŸ©å½¢çš„å³è¾¹ç¼˜
                else if (Math.abs(x + width - (rect.x + rect.width)) < threshold) {
                    showVerticalGuide = true;
                    guideX = rect.x + rect.width - width;
                    x = rect.x + rect.width - width;
                }
                // å¯¹é½åˆ°çŸ©å½¢çš„ä¸Šè¾¹ç¼˜
                if (Math.abs(y - rect.y) < threshold) {
                    showHorizontalGuide = true;
                    guideY = rect.y;
                    y = rect.y;
                }
                // å¯¹é½åˆ°çŸ©å½¢çš„ä¸‹è¾¹ç¼˜
                else if (Math.abs(y + height - (rect.y + rect.height)) < threshold) {
                    showHorizontalGuide = true;
                    guideY = rect.y + rect.height - height;
                    y = rect.y + rect.height - height;
                }
                // å¯¹é½åˆ°çŸ©å½¢ä¸­å¿ƒçº¿ï¼ˆæ°´å¹³ï¼‰
                else if (Math.abs(y + height / 2 - (rect.y + rect.height / 2)) < threshold) {
                    showHorizontalGuide = true;
                    guideY = rect.y + rect.height / 2 - height / 2;
                    y = rect.y + rect.height / 2 - height / 2;
                }
                // å¯¹é½åˆ°çŸ©å½¢ä¸­å¿ƒçº¿ï¼ˆå‚ç›´ï¼‰
                else if (Math.abs(x + width / 2 - (rect.x + rect.width / 2)) < threshold) {
                    showVerticalGuide = true;
                    guideX = rect.x + rect.width / 2 - width / 2;
                    x = rect.x + rect.width / 2 - width / 2;
                }
            });

            // æ˜¾ç¤ºå¯¹é½è¾…åŠ©çº¿
            if (showVerticalGuide || showHorizontalGuide) {
                showAlignmentGuides(guideX, guideY, showVerticalGuide, showHorizontalGuide);
            }

            return { x, y };
        }

        // æ˜¾ç¤ºå¯¹é½è¾…åŠ©çº¿
        function showAlignmentGuides(x, y, showVertical, showHorizontal) {
            const guidesDiv = document.getElementById('alignmentGuides');
            guidesDiv.innerHTML = '';

            if (showVertical) {
                const verticalGuide = document.createElement('div');
                verticalGuide.className = 'alignment-guide vertical';
                verticalGuide.style.left = x + 'px';
                verticalGuide.style.top = '0';
                guidesDiv.appendChild(verticalGuide);
            }

            if (showHorizontal) {
                const horizontalGuide = document.createElement('div');
                horizontalGuide.className = 'alignment-guide horizontal';
                horizontalGuide.style.left = '0';
                horizontalGuide.style.top = y + 'px';
                guidesDiv.appendChild(horizontalGuide);
            }
        }

        // æ›´æ–°çŸ©å½¢é«˜äº®çŠ¶æ€
        function updateRectangleHighlight(targetIndex) {
            // ç§»é™¤ä¹‹å‰çš„é«˜äº®
            if (currentDropTargetIndex >= 0) {
                const prevRect = document.querySelector(`.rect[data-index="${currentDropTargetIndex}"]`);
                if (prevRect) {
                    prevRect.classList.remove('drop-target');
                }
            }

            // æ·»åŠ æ–°çš„é«˜äº®
            if (targetIndex >= 0) {
                const targetRect = document.querySelector(`.rect[data-index="${targetIndex}"]`);
                if (targetRect) {
                    targetRect.classList.add('drop-target');
                }
            }

            currentDropTargetIndex = targetIndex;
        }

        // æ¸…é™¤å¯¹é½è¾…åŠ©çº¿
        function clearAlignmentGuides() {
            const guidesDiv = document.getElementById('alignmentGuides');
            guidesDiv.innerHTML = '';
        }


        // é€‰ä¸­çŸ©å½¢
        function selectRectangle(index) {
            selectedRectIndex = index;
            selectedIconIndex = -1;

            // æ›´æ–°æ˜¾ç¤º
            document.querySelectorAll('.rect').forEach(rect => {
                rect.classList.remove('selected');
            });

            // æ¸…é™¤æ‰€æœ‰å›¾æ ‡çš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.icon-hollow-rect').forEach(icon => {
                icon.classList.remove('selected');
            });

            if (currentLayout.rectangles[index]) {
                const rectDiv = document.querySelector(`.rect[data-index="${index}"]`);
                if (rectDiv) {
                    rectDiv.classList.add('selected');
                }

                // æ›´æ–°è¡¨å•å€¼
                document.getElementById('rectWidth').value = currentLayout.rectangles[index].width;
                document.getElementById('rectHeight').value = currentLayout.rectangles[index].height;
            }

            updateSelectedRectInfo();
        }

        // é€‰ä¸­å›¾æ ‡
        function selectIcon(rectIndex, iconIndex) {
            // 1. å…ˆé€‰ä¸­çŸ©å½¢ï¼ˆè¿™ä¼šé‡ç½® selectedIconIndex ä¸º -1ï¼Œå¹¶æ¸…é™¤æ‰€æœ‰å›¾æ ‡é€‰ä¸­æ ·å¼ï¼‰
            selectRectangle(rectIndex);

            // 2. é‡æ–°è®¾ç½®å›¾æ ‡é€‰ä¸­çŠ¶æ€
            selectedRectIndex = rectIndex;
            selectedIconIndex = iconIndex;

            // 3. è®¾ç½®å½“å‰å›¾æ ‡ä¸ºé€‰ä¸­çŠ¶æ€
            const iconDiv = document.querySelector(`.icon-hollow-rect[data-rect-index="${rectIndex}"][data-icon-index="${iconIndex}"]`);
            if (iconDiv) {
                iconDiv.classList.add('selected');
            }

            // 4. æ›´æ–°è¾“å…¥æ¡†æ•°æ®
            if (currentLayout.rectangles[rectIndex] &&
                currentLayout.rectangles[rectIndex].icons[iconIndex]) {
                const icon = currentLayout.rectangles[rectIndex].icons[iconIndex];
                document.getElementById('iconIndex').value = icon.icon_index;
                document.getElementById('iconWidth').value = icon.display_width || icon.original_width || 30;
                document.getElementById('iconHeight').value = icon.display_height || icon.original_height || 30;
            }

            // 5. å†æ¬¡æ›´æ–°ä¿¡æ¯é¢æ¿ï¼ˆå› ä¸º selectRectangle æ›´æ–°æ—¶ selectedIconIndex è¿˜æ˜¯ -1ï¼‰
            updateSelectedRectInfo();
        }

        // æ›´æ–°é€‰ä¸­çŸ©å½¢ä¿¡æ¯
        function updateSelectedRectInfo() {
            const infoDiv = document.getElementById('selectedRectInfo');

            if (selectedRectIndex >= 0 && currentLayout.rectangles[selectedRectIndex]) {
                const rect = currentLayout.rectangles[selectedRectIndex];
                let iconInfo = '';

                if (rect.icons && rect.icons.length > 0) {
                    iconInfo = '<p>å›¾æ ‡ä¿¡æ¯:</p><ul>';
                    rect.icons.forEach((icon, index) => {
                        iconInfo += `<li>å›¾æ ‡${index}: ç´¢å¼•=${icon.icon_index}, ä½ç½®=(${Math.round(icon.display_x || 0)}, ${Math.round(icon.display_y || 0)}), å°ºå¯¸=${icon.display_width || icon.original_width}Ã—${icon.display_height || icon.original_height}</li>`;
                    });
                    iconInfo += '</ul>';
                }

                let deleteBtn = '';
                if (selectedIconIndex >= 0) {
                    deleteBtn = `<button class="delete-btn" onclick="deleteSelected()">åˆ é™¤é€‰ä¸­å›¾æ ‡ (Deleteé”®)</button>`;
                } else {
                    deleteBtn = `<button class="delete-btn" onclick="deleteSelected()">åˆ é™¤é€‰ä¸­çŸ©å½¢ (Deleteé”®)</button>`;
                }

                infoDiv.innerHTML = `
                    <span class="rect-id">çŸ©å½¢ ${selectedRectIndex}</span>
                    <p>ä½ç½®: (${rect.x}, ${rect.y})</p>
                    <p>å°ºå¯¸: ${rect.width}Ã—${rect.height}</p>
                    <p>å›¾æ ‡æ•°: ${rect.icon_count || 0}</p>
                    <p>çŠ¶æ€æ : ${selectedRectIndex === currentLayout.status_rect_index ? 'æ˜¯' : 'å¦'}</p>
                    ${selectedIconIndex >= 0 ? `<p>é€‰ä¸­çš„å›¾æ ‡: ${selectedIconIndex} (ç´¢å¼•: ${currentLayout.rectangles[selectedRectIndex].icons[selectedIconIndex]?.icon_index || 'N/A'})</p>` : ''}
                    ${deleteBtn}
                    ${iconInfo}
                `;
            } else {
                infoDiv.innerHTML = 'æœªé€‰ä¸­ä»»ä½•çŸ©å½¢';
            }
        }

        // åˆ é™¤é€‰ä¸­é¡¹
        function deleteSelected() {
            if (selectedRectIndex >= 0) {
                if (selectedIconIndex >= 0) {
                    // åˆ é™¤å›¾æ ‡
                    const rect = currentLayout.rectangles[selectedRectIndex];
                    if (rect && rect.icons && rect.icons[selectedIconIndex]) {
                        rect.icons.splice(selectedIconIndex, 1);
                        rect.icon_count = rect.icons.length;

                        // æ¸…é™¤é€‰ä¸­çŠ¶æ€
                        selectedIconIndex = -1;

                        // é‡æ–°æ¸²æŸ“
                        renderLayout(currentLayout);

                        // æ›´æ–°ä¿¡æ¯é¢æ¿
                        updateSelectedRectInfo();

                        showStatus('å›¾æ ‡å·²åˆ é™¤', 'success');
                    }
                } else {
                    // åˆ é™¤çŸ©å½¢
                    removeSelectedRect();
                }
            }
        }

        // ç»‘å®šé”®ç›˜äº‹ä»¶
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Delete' || e.key === 'Backspace') {
                // å¦‚æœç„¦ç‚¹åœ¨è¾“å…¥æ¡†ä¸­ï¼Œä¸æ‰§è¡Œåˆ é™¤
                if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') {
                    return;
                }

                deleteSelected();
                e.preventDefault();
            }
        });
        //æ›´æ–°å±å¹•å°ºå¯¸
        async function updateScreenSize() {
            const width = parseInt(document.getElementById('screenWidth').value);
            const height = parseInt(document.getElementById('screenHeight').value);

            if (width >= 100 && width <= 800 && height >= 100 && height <= 600) {
                try {
                    // æ˜¾ç¤ºæ­£åœ¨æ›´æ–°çš„çŠ¶æ€
                    showStatus('æ­£åœ¨æ›´æ–°è®¾å¤‡å±å¹•å°ºå¯¸...', 'success');

                    // è·å–å½“å‰é¡µé¢çš„åŸºç¡€URL
                    const currentOrigin = window.location.origin;
                    console.log('å½“å‰é¡µé¢Origin:', currentOrigin);

                    // å‘é€è®¾ç½®å±å¹•å®½åº¦çš„å‘½ä»¤
                    const widthCommandUrl = `${currentOrigin}/command?commandText=$set/screenXSize=${width}&PAGE=0`;
                    console.log('å‘é€å®½åº¦å‘½ä»¤:', widthCommandUrl);

                    const widthResponse = await fetch(widthCommandUrl);
                    if (!widthResponse.ok) {
                        throw new Error(`è®¾ç½®å±å¹•å®½åº¦å¤±è´¥: HTTP ${widthResponse.status}`);
                    }
                    const widthResult = await widthResponse.text();
                    console.log('å®½åº¦å‘½ä»¤å“åº”:', widthResult);

                    // ç­‰å¾…ä¸€ä¸‹å†å‘é€é«˜åº¦å‘½ä»¤
                    await new Promise(resolve => setTimeout(resolve, 500));

                    // å‘é€è®¾ç½®å±å¹•é«˜åº¦çš„å‘½ä»¤
                    const heightCommandUrl = `${currentOrigin}/command?commandText=$set/screenYSize=${height}&PAGE=0`;
                    console.log('å‘é€é«˜åº¦å‘½ä»¤:', heightCommandUrl);

                    const heightResponse = await fetch(heightCommandUrl);
                    if (!heightResponse.ok) {
                        throw new Error(`è®¾ç½®å±å¹•é«˜åº¦å¤±è´¥: HTTP ${heightResponse.status}`);
                    }
                    const heightResult = await heightResponse.text();
                    console.log('é«˜åº¦å‘½ä»¤å“åº”:', heightResult);

                    // ç­‰å¾…ä¸€ä¸‹è®©å•ç‰‡æœºå®Œæˆè®¾ç½®
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    // æ›´æ–°æœ¬åœ°å¸ƒå±€æ•°æ®
                    currentLayout.screen.width = width;
                    currentLayout.screen.height = height;
                    currentLayout.screen.original_width = width;
                    currentLayout.screen.original_height = height;

                    // æ›´æ–°å±å¹•å®¹å™¨å°ºå¯¸
                    const screenContainer = document.getElementById('screenContainer');
                    screenContainer.style.width = width + 'px';
                    screenContainer.style.height = height + 'px';

                    // æ›´æ–°çŸ©å½¢è¾“å…¥æ¡†çš„æœ€å¤§å€¼
                    document.getElementById('rectWidth').max = width;
                    document.getElementById('rectHeight').max = height;

                    // æ›´æ–°æ˜¾ç¤ºçš„å±å¹•å°ºå¯¸ä¿¡æ¯
                    // document.getElementById('screenSize').textContent = `${width}Ã—${height}`;
                    // document.getElementById('designSize').textContent = `${width}Ã—${height}`;

                    // é‡æ–°ç»˜åˆ¶ç½‘æ ¼çº¿
                    drawGridLines();

                    // é‡æ–°ä»è®¾å¤‡è·å–å¸ƒå±€æ•°æ®
                    console.log('æ­£åœ¨è·å–æœ€æ–°å¸ƒå±€æ•°æ®...');
                    showStatus('æ­£åœ¨è·å–è®¾å¤‡æœ€æ–°å¸ƒå±€...', 'success');

                    try {
                        // è·å–æœ€æ–°å¸ƒå±€
                        const layoutData = await getCurrentLayoutFromDevice();

                        if (layoutData) {
                            console.log('æˆåŠŸè·å–æœ€æ–°å¸ƒå±€æ•°æ®');

                            // æ›´æ–°æœ¬åœ°currentLayoutï¼ˆgetCurrentLayoutFromDeviceå†…éƒ¨ä¼šè°ƒç”¨renderLayoutï¼‰
                            // ç¡®ä¿currentLayoutçš„å±å¹•å°ºå¯¸æ˜¯æœ€æ–°çš„
                            currentLayout.screen.width = width;
                            currentLayout.screen.height = height;
                            currentLayout.screen.original_width = width;
                            currentLayout.screen.original_height = height;

                            showStatus(`å±å¹•å°ºå¯¸å·²æ›´æ–°ä¸º ${width}Ã—${height}ï¼Œå¸ƒå±€å·²é‡æ–°åŠ è½½`, 'success');
                        } else {
                            throw new Error('è·å–å¸ƒå±€æ•°æ®è¿”å›null');
                        }

                    } catch (layoutError) {
                        console.log('è·å–æœ€æ–°å¸ƒå±€å¤±è´¥:', layoutError);

                        // å¦‚æœè·å–å¸ƒå±€å¤±è´¥ï¼Œé‡æ–°æ¸²æŸ“å½“å‰å¸ƒå±€
                        renderLayout(currentLayout);
                        showStatus(`å±å¹•å°ºå¯¸å·²æ›´æ–°ä¸º ${width}Ã—${height}ï¼Œä½†è·å–æœ€æ–°å¸ƒå±€å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®`, 'warning');
                    }

                } catch (error) {
                    console.error('æ›´æ–°å±å¹•å°ºå¯¸å¤±è´¥:', error);

                    // å³ä½¿è®¾å¤‡è®¾ç½®å¤±è´¥ï¼Œä¹Ÿæ›´æ–°æœ¬åœ°ç•Œé¢
                    currentLayout.screen.width = width;
                    currentLayout.screen.height = height;
                    currentLayout.screen.original_width = width;
                    currentLayout.screen.original_height = height;

                    const screenContainer = document.getElementById('screenContainer');
                    screenContainer.style.width = width + 'px';
                    screenContainer.style.height = height + 'px';

                    document.getElementById('screenSize').textContent = `${width}Ã—${height}`;
                    document.getElementById('designSize').textContent = `${width}Ã—${height}`;

                    document.getElementById('rectWidth').max = width;
                    document.getElementById('rectHeight').max = height;

                    drawGridLines();
                    renderLayout(currentLayout);

                    showStatus(`æœ¬åœ°å±å¹•å°ºå¯¸å·²æ›´æ–°ä¸º ${width}Ã—${height}ï¼Œä½†è®¾å¤‡è®¾ç½®å¤±è´¥: ${error.message}`, 'error');
                }
            } else {
                showStatus('è¯·è¾“å…¥æœ‰æ•ˆçš„å±å¹•å°ºå¯¸ (100-800 Ã— 100-600)', 'error');
            }
        }

        // æ·»åŠ æ–°çŸ©å½¢
        function addRectangle() {
            const width = parseInt(document.getElementById('rectWidth').value);
            const height = parseInt(document.getElementById('rectHeight').value);

            if (width < 10 || height < 10) {
                showStatus('çŸ©å½¢å°ºå¯¸å¤ªå°', 'error');
                return;
            }

            // æ‰¾ä¸€ä¸ªåˆé€‚çš„ä½ç½®æ”¾ç½®æ–°çŸ©å½¢
            let x = 10, y = 10;
            let placed = false;

            // ç®€å•çš„é¿è®©ç®—æ³•
            while (!placed) {
                let collision = false;
                for (const rect of currentLayout.rectangles) {
                    if (x < rect.x + rect.width &&
                        x + width > rect.x &&
                        y < rect.y + rect.height &&
                        y + height > rect.y) {
                        collision = true;
                        break;
                    }
                }

                if (!collision) {
                    placed = true;
                } else {
                    x += 20;
                    if (x + width > currentLayout.screen.width) {
                        x = 10;
                        y += 20;
                    }
                    if (y + height > currentLayout.screen.height) {
                        // å¦‚æœæ”¾ä¸ä¸‹ï¼Œæ”¾åœ¨ç¬¬ä¸€ä¸ªçŸ©å½¢çš„æ—è¾¹
                        x = currentLayout.rectangles[0]?.x + currentLayout.rectangles[0]?.width + 10 || 10;
                        y = currentLayout.rectangles[0]?.y || 10;
                        placed = true;
                    }
                }
            }

            const newRect = {
                x: x,
                y: y,
                width: width,
                height: height,
                original_x: x,
                original_y: y,
                original_width: width,
                original_height: height,
                icon_count: 0,
                icons: [],
                is_status_bar: false
            };

            currentLayout.rectangles.push(newRect);
            selectedRectIndex = currentLayout.rectangles.length - 1;
            selectedIconIndex = -1;

            renderLayout(currentLayout);
            showStatus('çŸ©å½¢æ·»åŠ æˆåŠŸ', 'success');
        }

        // åˆ é™¤é€‰ä¸­çŸ©å½¢
        function removeSelectedRect() {
            if (selectedRectIndex >= 0 && selectedRectIndex < currentLayout.rectangles.length) {
                currentLayout.rectangles.splice(selectedRectIndex, 1);
                selectedRectIndex = -1;
                selectedIconIndex = -1;
                renderLayout(currentLayout);
                showStatus('çŸ©å½¢åˆ é™¤æˆåŠŸ', 'success');
            } else {
                showStatus('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªçŸ©å½¢', 'error');
            }
        }

        // æ¸…ç©ºæ‰€æœ‰çŸ©å½¢
        function clearAllRectangles() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰çŸ©å½¢å—ï¼Ÿ')) {
                currentLayout.rectangles = [];
                selectedRectIndex = -1;
                selectedIconIndex = -1;
                renderLayout(currentLayout);
                showStatus('æ‰€æœ‰çŸ©å½¢å·²æ¸…ç©º', 'success');
            }
        }

        // æ·»åŠ å›¾æ ‡åˆ°é€‰ä¸­çŸ©å½¢
        function addIconToSelectedRect() {
            if (selectedRectIndex < 0 || selectedRectIndex >= currentLayout.rectangles.length) {
                showStatus('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªçŸ©å½¢', 'error');
                return;
            }

            const rect = currentLayout.rectangles[selectedRectIndex];
            const iconIndex = parseInt(document.getElementById('iconIndex').value);

            if (iconIndex < 0 || iconIndex > 5) {
                showStatus('å›¾æ ‡ç´¢å¼•å¿…é¡»åœ¨0-5ä¹‹é—´', 'error');
                return;
            }

            // ä½¿ç”¨è¾“å…¥æ¡†ä¸­çš„å›¾æ ‡å°ºå¯¸
            const iconWidth = parseInt(document.getElementById('iconWidth').value) || 30;
            const iconHeight = parseInt(document.getElementById('iconHeight').value) || 30;

            // è®¡ç®—å›¾æ ‡ä½ç½®ï¼ˆé»˜è®¤åœ¨çŸ©å½¢ä¸­å¿ƒï¼‰
            const iconX = rect.x + rect.width / 2 - iconWidth / 2;
            const iconY = rect.y + rect.height / 2 - iconHeight / 2;

            const icon = {
                rect_index: selectedRectIndex,
                icon_index: iconIndex,
                rel_x: 0.5,
                rel_y: 0.5,
                display_x: iconX,
                display_y: iconY,
                display_width: iconWidth,
                display_height: iconHeight
            };

            if (!rect.icons) rect.icons = [];
            rect.icons.push(icon);
            rect.icon_count = rect.icons.length;

            renderLayout(currentLayout);
            
            // é€‰ä¸­æ–°æ·»åŠ çš„å›¾æ ‡
            selectIcon(selectedRectIndex, rect.icons.length - 1);
            
            showStatus('å›¾æ ‡æ·»åŠ æˆåŠŸ', 'success');
        }

        // åˆ é™¤é€‰ä¸­å›¾æ ‡
        function removeSelectedIcon() {
            if (selectedRectIndex >= 0 && selectedIconIndex >= 0) {
                const rect = currentLayout.rectangles[selectedRectIndex];
                if (rect && rect.icons && rect.icons[selectedIconIndex]) {
                    rect.icons.splice(selectedIconIndex, 1);
                    rect.icon_count = rect.icons.length;
                    selectedIconIndex = -1;
                    renderLayout(currentLayout);
                    showStatus('å›¾æ ‡åˆ é™¤æˆåŠŸ', 'success');
                }
            } else {
                showStatus('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå›¾æ ‡', 'error');
            }
        }

        // æ›´æ–°é€‰ä¸­å›¾æ ‡å°ºå¯¸
        function updateSelectedIconSize() {
            if (selectedRectIndex >= 0 && selectedIconIndex >= 0) {
                const rect = currentLayout.rectangles[selectedRectIndex];
                if (rect && rect.icons && rect.icons[selectedIconIndex]) {
                    const icon = rect.icons[selectedIconIndex];
                    const newWidth = parseInt(document.getElementById('iconWidth').value) || icon.original_width;
                    const newHeight = parseInt(document.getElementById('iconHeight').value) || icon.original_height;

                    // ä¿æŒå›¾æ ‡ä¸­å¿ƒä½ç½®ä¸å˜
                    const centerX = icon.display_x + icon.display_width / 2;
                    const centerY = icon.display_y + icon.display_height / 2;

                    icon.display_width = newWidth;
                    icon.display_height = newHeight;
                    icon.display_x = centerX - newWidth / 2;
                    icon.display_y = centerY - newHeight / 2;

                    renderLayout(currentLayout);
                    showStatus('å›¾æ ‡å°ºå¯¸å·²æ›´æ–°', 'success');
                }
            } else {
                showStatus('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå›¾æ ‡', 'error');
            }
        }

        // è‡ªåŠ¨æ’åˆ—å›¾æ ‡
        function autoArrangeIcons() {
            currentLayout.rectangles.forEach((rect, rectIndex) => {
                if (rect.icons && rect.icons.length > 0) {
                    const cols = Math.ceil(Math.sqrt(rect.icons.length));
                    const rows = Math.ceil(rect.icons.length / cols);

                    rect.icons.forEach((icon, iconIndex) => {
                        const row = Math.floor(iconIndex / cols);
                        const col = iconIndex % cols;

                        const cellWidth = rect.width / cols;
                        const cellHeight = rect.height / rows;

                        const iconWidth = icon.display_width || icon.original_width || 30;
                        const iconHeight = icon.display_height || icon.original_height || 30;

                        icon.rel_x = (col + 0.5) / cols;
                        icon.rel_y = (row + 0.5) / rows;
                        icon.display_x = rect.x + col * cellWidth + cellWidth / 2 - iconWidth / 2;
                        icon.display_y = rect.y + row * cellHeight + cellHeight / 2 - iconHeight / 2;
                    });
                }
            });

            renderLayout(currentLayout);
            showStatus('å›¾æ ‡è‡ªåŠ¨æ’åˆ—å®Œæˆ', 'success');
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = 'status-message status-' + type;
            statusDiv.style.display = 'block';

            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }

        // è·å–å½“å‰å¸ƒå±€
        function getCurrentLayout() {
            console.log('å¼€å§‹ç”Ÿæˆå¸ƒå±€æ•°æ®...');

            // ç¡®ä¿æ‰€æœ‰å›¾æ ‡æ•°æ®éƒ½æ˜¯æœ€æ–°çš„
            currentLayout.rectangles.forEach((rect, rectIndex) => {
                console.log(`å¤„ç†çŸ©å½¢ ${rectIndex}: ä½ç½®(${rect.x},${rect.y}), å°ºå¯¸(${rect.width}x${rect.height})`);

                if (rect.icons && Array.isArray(rect.icons)) {
                    rect.icons.forEach((icon, iconIndex) => {
                        // ä»DOMå…ƒç´ è·å–æœ€æ–°ä½ç½®å’Œå°ºå¯¸
                        const iconDiv = document.querySelector(
                            `.icon-hollow-rect[data-rect-index="${rectIndex}"][data-icon-index="${iconIndex}"]`
                        );
                        if (iconDiv) {
                            // è·å–DOMä¸­çš„å®é™…ä½ç½®å’Œå°ºå¯¸
                            const domX = parseInt(iconDiv.style.left) || 0;
                            const domY = parseInt(iconDiv.style.top) || 0;
                            const domWidth = parseInt(iconDiv.style.width) || 30;
                            const domHeight = parseInt(iconDiv.style.height) || 30;

                            console.log(`  çŸ©å½¢ ${rectIndex} å›¾æ ‡ ${iconIndex}:`);
                            console.log(`    DOMä½ç½®: (${domX},${domY}), å°ºå¯¸: ${domWidth}x${domHeight}`);

                            // å­˜å‚¨æ˜¾ç¤ºä½ç½®å’Œå°ºå¯¸
                            icon.display_x = Number(domX);
                            icon.display_y = Number(domY);
                            icon.display_width = Number(domWidth);
                            icon.display_height = Number(domHeight);

                            // é‡æ–°è®¡ç®—ç›¸å¯¹ä½ç½®ï¼ˆä½¿ç”¨å›¾æ ‡å·¦ä¸Šè§’ï¼‰
                            if (rect.width > 0 && rect.height > 0) {
                                // ä½¿ç”¨å›¾æ ‡å·¦ä¸Šè§’è®¡ç®—ç›¸å¯¹ä½ç½®
                                let rel_x = (domX - rect.x) / rect.width;
                                let rel_y = (domY - rect.y) / rect.height;

                                // ç¡®ä¿åœ¨0-1èŒƒå›´å†…
                                rel_x = Math.max(0, Math.min(1, rel_x));
                                rel_y = Math.max(0, Math.min(1, rel_y));

                                // ä¿ç•™ä¸€ä½å°æ•°ï¼Œå››èˆäº”å…¥
                                rel_x = Math.round(rel_x * 10) / 10;
                                rel_y = Math.round(rel_y * 10) / 10;

                                // ä¿å­˜åˆ°å›¾æ ‡æ•°æ®ä¸­
                                icon.rel_x = rel_x;
                                icon.rel_y = rel_y;

                                console.log(`    ç›¸å¯¹ä½ç½®: (${rel_x},${rel_y}) ä¿ç•™ä¸€ä½å°æ•°`);
                            }

                            // æ¸…ç†ä¸å¿…è¦çš„å±æ€§
                            delete icon.original_x;
                            delete icon.original_y;
                            delete icon.original_width;
                            delete icon.original_height;
                        } else {
                            console.warn(`æ‰¾ä¸åˆ°çŸ©å½¢ ${rectIndex} çš„å›¾æ ‡ ${iconIndex} çš„DOMå…ƒç´ `);
                        }
                    });
                }

                // æ¸…ç†çŸ©å½¢çš„ä¸å¿…è¦å±æ€§
                delete rect.original_x;
                delete rect.original_y;
                delete rect.original_width;
                delete rect.original_height;
            });

            // ç®€åŒ–æ•°æ®ç»“æ„ï¼Œåªå‘é€æœåŠ¡å™¨éœ€è¦çš„å­—æ®µ
            const simplifiedLayout = {
                screen_width: currentLayout.screen.width,
                screen_height: currentLayout.screen.height,
                rectangles: currentLayout.rectangles.map(rect => ({
                    x: Number(rect.x),
                    y: Number(rect.y),
                    width: Number(rect.width),
                    height: Number(rect.height),
                    icon_count: Number(rect.icons?.length || 0),
                    icons: rect.icons?.map(icon => ({
                        icon_index: Number(icon.icon_index),
                        // è¿™é‡Œç›´æ¥ä½¿ç”¨å·²ç»ä¿ç•™ä¸€ä½å°æ•°çš„rel_xå’Œrel_y
                        rel_x: Number(icon.rel_x),
                        rel_y: Number(icon.rel_y),
                        display_x: Number(icon.display_x),
                        display_y: Number(icon.display_y),
                        display_width: Number(icon.display_width),
                        display_height: Number(icon.display_height)
                    })) || []
                })),
                status_rect_index: Number(currentLayout.status_rect_index || 0)
            };

            console.log('ç®€åŒ–çš„å¸ƒå±€æ•°æ®:', JSON.stringify(simplifiedLayout, null, 2));

            // éªŒè¯ä¿ç•™ä¸€ä½å°æ•°çš„æ•ˆæœ
            simplifiedLayout.rectangles.forEach((rect, i) => {
                if (rect.icons && rect.icons.length > 0) {
                    console.log(`çŸ©å½¢ ${i} å›¾æ ‡ç›¸å¯¹ä½ç½®:`);
                    rect.icons.forEach((icon, j) => {
                        console.log(`  å›¾æ ‡ ${j}: rel_x=${icon.rel_x}, rel_y=${icon.rel_y}`);
                    });
                }
            });

            return simplifiedLayout;
        }
        // éªŒè¯å¸ƒå±€æ•°æ®
        function validateLayoutData(layoutData) {
            const errors = [];

            if (!layoutData) {
                errors.push('å¸ƒå±€æ•°æ®ä¸ºç©º');
                return errors;
            }

            // éªŒè¯å±å¹•å°ºå¯¸
            if (!layoutData.screen_width || !layoutData.screen_height) {
                errors.push('å±å¹•å°ºå¯¸æ•°æ®ä¸å®Œæ•´');
            }

            if (layoutData.screen_width <= 0 || layoutData.screen_height <= 0) {
                errors.push('å±å¹•å°ºå¯¸å¿…é¡»å¤§äº0');
            }

            // éªŒè¯çŸ©å½¢æ•°æ®
            if (!Array.isArray(layoutData.rectangles)) {
                errors.push('rectangles å¿…é¡»æ˜¯ä¸€ä¸ªæ•°ç»„');
                return errors;
            }

            layoutData.rectangles.forEach((rect, index) => {
                if (!rect || typeof rect !== 'object') {
                    errors.push(`çŸ©å½¢ ${index} æ•°æ®æ ¼å¼é”™è¯¯`);
                    return;
                }

                // éªŒè¯å¿…éœ€å­—æ®µ
                const requiredFields = ['x', 'y', 'width', 'height'];
                requiredFields.forEach(field => {
                    if (rect[field] === undefined || rect[field] === null) {
                        errors.push(`çŸ©å½¢ ${index} ç¼ºå°‘ ${field} å­—æ®µ`);
                    } else if (typeof rect[field] !== 'number' || isNaN(rect[field])) {
                        errors.push(`çŸ©å½¢ ${index} çš„ ${field} å¿…é¡»æ˜¯æ•°å­—`);
                    } else if (rect[field] < 0) {
                        errors.push(`çŸ©å½¢ ${index} çš„ ${field} ä¸èƒ½ä¸ºè´Ÿæ•°`);
                    }
                });

                // éªŒè¯å›¾æ ‡æ•°æ®
                if (rect.icons && Array.isArray(rect.icons)) {
                    rect.icons.forEach((icon, iconIndex) => {
                        if (!icon || typeof icon !== 'object') {
                            errors.push(`çŸ©å½¢ ${index} çš„å›¾æ ‡ ${iconIndex} æ•°æ®æ ¼å¼é”™è¯¯`);
                            return;
                        }

                        // éªŒè¯å›¾æ ‡å¿…éœ€å­—æ®µ
                        if (icon.icon_index === undefined || icon.icon_index === null) {
                            errors.push(`çŸ©å½¢ ${index} çš„å›¾æ ‡ ${iconIndex} ç¼ºå°‘ icon_index å­—æ®µ`);
                        }

                        // éªŒè¯åæ ‡å’Œå°ºå¯¸
                        const iconFields = ['rel_x', 'rel_y', 'display_x', 'display_y', 'display_width', 'display_height'];
                        iconFields.forEach(field => {
                            if (icon[field] !== undefined && (typeof icon[field] !== 'number' || isNaN(icon[field]))) {
                                errors.push(`çŸ©å½¢ ${index} çš„å›¾æ ‡ ${iconIndex} çš„ ${field} å¿…é¡»æ˜¯æ•°å­—`);
                            }
                        });
                    });
                }
            });

            return errors;
        }
        // ä¿®æ”¹ applyToDevice å‡½æ•°ï¼Œæ·»åŠ éªŒè¯
        async function applyToDevice() {
            try {
                const layoutData = getCurrentLayout();

                console.log('æ­£åœ¨å‘é€å¸ƒå±€æ•°æ®åˆ°è®¾å¤‡:', layoutData);

                // éªŒè¯æ•°æ®
                const validationErrors = validateLayoutData(layoutData);
                if (validationErrors.length > 0) {
                    console.error('æ•°æ®éªŒè¯å¤±è´¥:', validationErrors);
                    showStatus('æ•°æ®éªŒè¯å¤±è´¥: ' + validationErrors.join(', '), 'error');
                    return;
                }

                const response = await fetch('/setlayout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(layoutData)
                });

                console.log('å“åº”çŠ¶æ€:', response.status, response.statusText);

                if (response.ok) {
                    const result = await response.json();
                    console.log('æœåŠ¡å™¨å“åº”:', result);
                    showStatus('å¸ƒå±€å·²æˆåŠŸåº”ç”¨åˆ°è®¾å¤‡', 'success');
                } else {
                    // å°è¯•è·å–é”™è¯¯è¯¦æƒ…
                    let errorDetail = '';
                    try {
                        const errorData = await response.text();
                        console.error('é”™è¯¯å“åº”å†…å®¹:', errorData);

                        // å°è¯•è§£æJSONé”™è¯¯
                        try {
                            const errorJson = JSON.parse(errorData);
                            errorDetail = ': ' + JSON.stringify(errorJson);
                        } catch {
                            errorDetail = ': ' + errorData.substring(0, 100);
                        }
                    } catch (e) {
                        errorDetail = 'ï¼Œæ— æ³•è·å–é”™è¯¯è¯¦æƒ…';
                    }
                    showStatus(`åº”ç”¨å¸ƒå±€å¤±è´¥ (HTTP ${response.status}${errorDetail})`, 'error');
                }
            } catch (error) {
                console.error('Error applying layout:', error);
                showStatus('è¿æ¥è®¾å¤‡å¤±è´¥: ' + error.message, 'error');
            }
        }
        // æµ‹è¯•æ•°æ®æ ¼å¼
        function testLayoutData() {
            const layoutData = getCurrentLayout();

            // éªŒè¯æ•°æ®
            const validationErrors = validateLayoutData(layoutData);

            if (validationErrors.length > 0) {
                console.error('æ•°æ®éªŒè¯å¤±è´¥:', validationErrors);
                alert('æ•°æ®éªŒè¯å¤±è´¥:\n' + validationErrors.join('\n'));
            } else {
                console.log('æ•°æ®éªŒè¯é€šè¿‡:', layoutData);

                // æ˜¾ç¤ºæ•°æ®ç»Ÿè®¡
                const rectCount = layoutData.rectangles.length;
                let iconCount = 0;
                layoutData.rectangles.forEach(rect => {
                    if (rect.icons && Array.isArray(rect.icons)) {
                        iconCount += rect.icons.length;
                    }
                });

                alert(`æ•°æ®éªŒè¯é€šè¿‡ï¼\nçŸ©å½¢æ•°: ${rectCount}\nå›¾æ ‡æ•°: ${iconCount}\nå±å¹•å°ºå¯¸: ${layoutData.screen_width}Ã—${layoutData.screen_height}`);
            }
        }
        // ä¿å­˜å¸ƒå±€åˆ°æ–‡ä»¶
        function saveLayoutToFile() {
            const layoutData = getCurrentLayout();
            const dataStr = JSON.stringify(layoutData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });

            const downloadAnchor = document.createElement('a');
            downloadAnchor.setAttribute('href', URL.createObjectURL(dataBlob));
            downloadAnchor.setAttribute('download', 'ink_screen_layout.json');
            document.body.appendChild(downloadAnchor);
            downloadAnchor.click();
            document.body.removeChild(downloadAnchor);

            showStatus('å¸ƒå±€å·²ä¿å­˜åˆ°æ–‡ä»¶', 'success');
        }

        // ä»æ–‡ä»¶åŠ è½½å¸ƒå±€
        function loadLayoutFromFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';

            input.onchange = function (e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const layout = JSON.parse(e.target.result);
                        currentLayout = layout;
                        renderLayout(currentLayout);
                        showStatus('å¸ƒå±€ä»æ–‡ä»¶åŠ è½½æˆåŠŸ', 'success');
                    } catch (error) {
                        showStatus('æ–‡ä»¶æ ¼å¼é”™è¯¯', 'error');
                    }
                };
                reader.readAsText(file);
            };

            input.click();
        }

        // é‡ç½®ä¸ºé»˜è®¤å¸ƒå±€
        function resetToDefault() {
            if (confirm('ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤å¸ƒå±€å—ï¼Ÿ')) {
                setDefaultLayout();
                renderLayout(currentLayout);
                showStatus('å·²é‡ç½®ä¸ºé»˜è®¤å¸ƒå±€', 'success');
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);

        // ç‚¹å‡»å±å¹•ç©ºç™½å¤„å–æ¶ˆé€‰ä¸­
        document.getElementById('screenContainer').onclick = function (e) {
            if (e.target === this || e.target.className === 'grid-lines' || e.target.id === 'alignmentGuides') {
                selectedRectIndex = -1;
                selectedIconIndex = -1;

                // æ¸…é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.rect').forEach(rect => {
                    rect.classList.remove('selected');
                });
                document.querySelectorAll('.icon-hollow-rect').forEach(icon => {
                    icon.classList.remove('selected');
                });

                updateSelectedRectInfo();
            }
        };
    </script>
</body>

</html>
)rawliteral";