# ğŸ“· å›¾ç‰‡è½¬ .bin æ–‡ä»¶ - å®Œæ•´ä½¿ç”¨æŒ‡å—

## âœ… åŠŸèƒ½æ¦‚è¿°

**æ˜¯çš„ï¼å›¾ç‰‡å¯ä»¥è½¬æ¢ä¸º .bin æ–‡ä»¶åœ¨å¢¨æ°´å±ä¸Šæ˜¾ç¤ºï¼**

ä¸å­—åº“ .bin æ–‡ä»¶ç±»ä¼¼ï¼Œå›¾ç‰‡ .bin æ–‡ä»¶å¯ä»¥ï¼š
- å­˜å‚¨åœ¨ SD å¡ä¸Šï¼ŒèŠ‚çœ Flash ç©ºé—´
- åŠ¨æ€åŠ è½½ï¼Œæ— éœ€é‡æ–°ç¼–è¯‘å›ºä»¶
- æ”¯æŒä»»æ„å°ºå¯¸çš„å›¾ç‰‡
- ä½¿ç”¨æŠ–åŠ¨ç®—æ³•ä¼˜åŒ–å¢¨æ°´å±æ˜¾ç¤ºæ•ˆæœ

---

## ğŸ“‹ å®Œæ•´å·¥ä½œæµç¨‹

### 1ï¸âƒ£ **å‡†å¤‡å›¾ç‰‡**
æ”¯æŒæ ¼å¼ï¼šJPG, PNG, BMP, GIF ç­‰å¸¸è§æ ¼å¼

```
ç¤ºä¾‹å›¾ç‰‡:
- logo.png (å…¬å¸ Logo)
- photo.jpg (äº§å“ç…§ç‰‡)
- icon.bmp (å›¾æ ‡)
```

### 2ï¸âƒ£ **å¯åŠ¨ Python æœåŠ¡**

```bash
cd tools
python ttf_to_gfx_webservice.py
```

è¾“å‡ºï¼š
```
============================================================
TTF è½¬ GFX Web æœåŠ¡å¯åŠ¨ä¸­...
============================================================
è®¿é—®: http://localhost:5000
API ç«¯ç‚¹:
  - å›¾ç‰‡è½¬.bin: http://localhost:5000/convert_image_to_bin
  ...
============================================================
```

### 3ï¸âƒ£ **åœ¨ç½‘é¡µä¸­è½¬æ¢å›¾ç‰‡**

æ‰“å¼€ `http://<ESP32_IP>/web_layout.html`ï¼Œæ‰¾åˆ° **"ğŸ“· å›¾ç‰‡è½¬ä½å›¾"** åŒºåŸŸï¼š

#### ç•Œé¢æ“ä½œï¼š
1. **ä¸Šä¼ å›¾ç‰‡**: ç‚¹å‡»"é€‰æ‹©å›¾ç‰‡æ–‡ä»¶"æŒ‰é’®
2. **è®¾ç½®å°ºå¯¸**: 
   - å®½åº¦: 240 (å¢¨æ°´å±å®½åº¦)
   - é«˜åº¦: 416 (å¢¨æ°´å±é«˜åº¦)
   - æˆ–è‡ªå®šä¹‰å°ºå¯¸
3. **é€‰æ‹©å¤„ç†æ¨¡å¼**:
   - âœ… **æŠ–åŠ¨ç®—æ³• (æ¨è)**: Floyd-Steinberg æŠ–åŠ¨ï¼Œæ•ˆæœæ›´å¥½
   - é˜ˆå€¼äºŒå€¼åŒ–: ç®€å•ç²—æš´ï¼Œé»‘ç™½åˆ†æ˜
4. **é¢„è§ˆæ•ˆæœ**: ç‚¹å‡»"é¢„è§ˆå¤„ç†æ•ˆæœ"æŸ¥çœ‹è½¬æ¢åçš„é»‘ç™½æ•ˆæœ
5. **ç”Ÿæˆ .bin**: ç‚¹å‡» **"ğŸ”„ ç”Ÿæˆ .bin æ–‡ä»¶"** (æ–°å¢æŒ‰é’®)

#### ç”Ÿæˆçš„æ–‡ä»¶ï¼š
```
components/images/logo_240x416.bin
```

æ–‡ä»¶ç»“æ„ï¼š
```
[0-3å­—èŠ‚]   å®½åº¦ (240, å°ç«¯åº)
[4-7å­—èŠ‚]   é«˜åº¦ (416, å°ç«¯åº)
[8-...]     ä½å›¾æ•°æ® (æ¯8åƒç´ =1å­—èŠ‚)
```

### 4ï¸âƒ£ **å¤åˆ¶åˆ° SD å¡**

```
SDå¡ç›®å½•ç»“æ„:
/sd/
  â”œâ”€â”€ logo_240x416.bin         (å…¨å± Logo)
  â”œâ”€â”€ icon_64x64.bin          (å°å›¾æ ‡)
  â”œâ”€â”€ photo_200x200.bin       (äº§å“ç…§ç‰‡)
  â””â”€â”€ fangsong_gb2312_16x16.bin (å­—åº“æ–‡ä»¶)
```

### 5ï¸âƒ£ **ESP32 ä»£ç æ˜¾ç¤ºå›¾ç‰‡**

#### ç®€å•ç¤ºä¾‹ï¼š
```cpp
#include "image_loader.h"

void setup() {
    // åˆå§‹åŒ–å¢¨æ°´å±...
    display.init();
    
    // æ˜¾ç¤ºSDå¡ä¸­çš„å›¾ç‰‡
    display.firstPage();
    do {
        display.fillScreen(GxEPD_WHITE);
        
        // æ˜¾ç¤ºå…¨å± Logo (ä½ç½® 0,0)
        displayImageFromSD("/sd/logo_240x416.bin", 0, 0, display);
        
    } while (display.nextPage());
}
```

#### å¤šå›¾ç»„åˆç¤ºä¾‹ï¼š
```cpp
void displayDashboard() {
    display.firstPage();
    do {
        display.fillScreen(GxEPD_WHITE);
        
        // é¡¶éƒ¨ Logo (64x64)
        displayImageFromSD("/sd/logo_64x64.bin", 10, 10, display);
        
        // ä¸­é—´äº§å“ç…§ç‰‡ (200x200)
        displayImageFromSD("/sd/photo_200x200.bin", 20, 100, display);
        
        // åº•éƒ¨å›¾æ ‡ (32x32)
        displayImageFromSD("/sd/wifi_icon_32x32.bin", 10, 370, display);
        displayImageFromSD("/sd/battery_icon_32x32.bin", 60, 370, display);
        
        // å åŠ ä¸­æ–‡æ–‡å­—
        displayChineseText(display, "äº§å“å±•ç¤º", 20, 320);
        
    } while (display.nextPage());
}
```

#### é«˜çº§ç¤ºä¾‹ - é¢„åŠ è½½æ£€æŸ¥ï¼š
```cpp
void displayImageWithCheck(const char* filename, int16_t x, int16_t y) {
    uint32_t width, height;
    
    // å…ˆè·å–å›¾ç‰‡ä¿¡æ¯
    if (getImageInfo(filename, &width, &height)) {
        ESP_LOGI(TAG, "å›¾ç‰‡å°ºå¯¸: %dx%d", width, height);
        
        // æ£€æŸ¥æ˜¯å¦è¶…å‡ºå±å¹•è¾¹ç•Œ
        if (x + width <= 240 && y + height <= 416) {
            displayImageFromSD(filename, x, y, display);
        } else {
            ESP_LOGW(TAG, "å›¾ç‰‡è¶…å‡ºå±å¹•èŒƒå›´!");
        }
    } else {
        ESP_LOGE(TAG, "æ— æ³•è¯»å–å›¾ç‰‡: %s", filename);
    }
}
```

---

## ğŸ†š å›¾ç‰‡ .bin vs å­—åº“ .bin å¯¹æ¯”

| ç‰¹æ€§ | å›¾ç‰‡ .bin | å­—åº“ .bin |
|------|----------|----------|
| **æ–‡ä»¶å¤´** | 8å­—èŠ‚ (å®½+é«˜) | æ—  (å›ºå®šèŒƒå›´) |
| **æ•°æ®ç»„ç»‡** | å•ä¸ªä½å›¾ | 20902ä¸ªå­—ç¬¦ä½å›¾ |
| **æ–‡ä»¶å¤§å°** | æ ¹æ®å°ºå¯¸ (å¦‚ 240x416 â‰ˆ 12KB) | å›ºå®š (16x16 â‰ˆ 650KB) |
| **æŸ¥æ‰¾æ–¹å¼** | ç›´æ¥è¯»å– | åç§»è®¡ç®— |
| **é€‚ç”¨åœºæ™¯** | Logoã€å›¾æ ‡ã€ç…§ç‰‡ | ä¸­æ–‡æ–‡æœ¬æ˜¾ç¤º |
| **ç”Ÿæˆå·¥å…·** | ä»»æ„å›¾ç‰‡ | TTF å­—ä½“ |

---

## ğŸ“Š .bin æ–‡ä»¶æ ¼å¼è¯¦è§£

### å›¾ç‰‡ .bin æ ¼å¼ï¼š
```
åç§»    å­—èŠ‚æ•°   è¯´æ˜
0x00    4       å®½åº¦ (uint32_t, å°ç«¯åº)
0x04    4       é«˜åº¦ (uint32_t, å°ç«¯åº)
0x08    ...     ä½å›¾æ•°æ® (æ¯8åƒç´ =1å­—èŠ‚, é€è¡Œæ‰«æ)

ç¤ºä¾‹: 240x416 å›¾ç‰‡
- æ–‡ä»¶å¤´: 8 å­—èŠ‚
- æ¯è¡Œ: (240+7)/8 = 30 å­—èŠ‚
- æ€»è¡Œæ•°: 416
- ä½å›¾å¤§å°: 30 Ã— 416 = 12480 å­—èŠ‚
- æ€»æ–‡ä»¶: 8 + 12480 = 12488 å­—èŠ‚ â‰ˆ 12.2 KB
```

### ä½å›¾ç¼–ç æ–¹å¼ï¼š
```
åƒç´ é¡ºåº: ä»å·¦åˆ°å³, ä»ä¸Šåˆ°ä¸‹
å­—èŠ‚æ‰“åŒ…: é«˜ä½åœ¨å·¦ (MSB first)

ç¤ºä¾‹ (8x2 å›¾ç‰‡):
åƒç´ : â– â–¡â– â–¡â– â– â– â–¡  â†’  å­—èŠ‚: 0b10101110 = 0xAE
      â–¡â–¡â–¡â–¡â– â– â– â–   â†’  å­—èŠ‚: 0b00001111 = 0x0F

æ–‡ä»¶å†…å®¹:
[0x08 0x00 0x00 0x00]  â† å®½åº¦ = 8
[0x02 0x00 0x00 0x00]  â† é«˜åº¦ = 2
[0xAE]                  â† ç¬¬1è¡Œæ•°æ®
[0x0F]                  â† ç¬¬2è¡Œæ•°æ®
```

---

## ğŸ”§ API å‡½æ•°è¯´æ˜

### `displayImageFromSD()`
```cpp
bool displayImageFromSD(const char* filename, int16_t x, int16_t y,
                        GxEPD2_BW<...>& display);
```
**åŠŸèƒ½**: ä»SDå¡åŠ è½½å¹¶æ˜¾ç¤ºå›¾ç‰‡  
**å‚æ•°**:
- `filename`: SDå¡è·¯å¾„ (å¦‚ "/sd/logo.bin")
- `x, y`: æ˜¾ç¤ºä½ç½®åæ ‡
- `display`: GxEPD2 æ˜¾ç¤ºå¯¹è±¡å¼•ç”¨

**è¿”å›**: true=æˆåŠŸ, false=å¤±è´¥

### `getImageInfo()`
```cpp
bool getImageInfo(const char* filename, uint32_t* width, uint32_t* height);
```
**åŠŸèƒ½**: è¯»å–å›¾ç‰‡å°ºå¯¸ä¿¡æ¯ï¼ˆä¸åŠ è½½æ•°æ®ï¼‰  
**ç”¨é€”**: æå‰æ£€æŸ¥å›¾ç‰‡å¤§å°ï¼Œé¿å…å†…å­˜æº¢å‡º

### `loadImageToBuffer()`
```cpp
bool loadImageToBuffer(const char* filename, uint8_t* buffer,
                       uint32_t* width, uint32_t* height);
```
**åŠŸèƒ½**: åŠ è½½å›¾ç‰‡åˆ°è‡ªå®šä¹‰ç¼“å†²åŒº  
**ç”¨é€”**: é«˜çº§ç”¨æˆ·ï¼Œéœ€è¦è‡ªè¡Œç®¡ç†å†…å­˜

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. **å›¾ç‰‡å°ºå¯¸ä¼˜åŒ–**
```cpp
// å…¨å±å›¾ç‰‡ (240x416) - é€‚åˆ Logo/å¯åŠ¨ç”»é¢
displayImageFromSD("/sd/splash_240x416.bin", 0, 0, display);

// ä¸­ç­‰å›¾ç‰‡ (200x200) - é€‚åˆäº§å“ç…§ç‰‡
displayImageFromSD("/sd/product_200x200.bin", 20, 100, display);

// å°å›¾æ ‡ (32x32, 64x64) - é€‚åˆçŠ¶æ€å›¾æ ‡
displayImageFromSD("/sd/icon_32x32.bin", 10, 10, display);
```

### 2. **å†…å­˜ç®¡ç†**
```cpp
// âœ… æ¨è: é€ä¸ªæ˜¾ç¤º,è‡ªåŠ¨é‡Šæ”¾å†…å­˜
displayImageFromSD("/sd/img1.bin", 0, 0, display);
displayImageFromSD("/sd/img2.bin", 100, 100, display);

// âŒ é¿å…: ä¸€æ¬¡åŠ è½½å¤šä¸ªå¤§å›¾ç‰‡åˆ°å†…å­˜
uint8_t* buf1 = malloc(50000);  // å¯èƒ½ OOM!
uint8_t* buf2 = malloc(50000);
```

### 3. **é”™è¯¯å¤„ç†**
```cpp
if (!displayImageFromSD("/sd/logo.bin", 0, 0, display)) {
    // æ˜¾ç¤ºå¤±è´¥æ—¶çš„åå¤‡æ–¹æ¡ˆ
    display.setCursor(10, 50);
    display.print("Image Load Failed");
}
```

### 4. **SDå¡æ–‡ä»¶æ£€æŸ¥**
```cpp
void checkSDCard() {
    if (!SD.exists("/sd/logo.bin")) {
        ESP_LOGW(TAG, "å›¾ç‰‡æ–‡ä»¶ä¸å­˜åœ¨,ä½¿ç”¨é»˜è®¤ç•Œé¢");
        displayDefaultUI();
    } else {
        displayImageFromSD("/sd/logo.bin", 0, 0, display);
    }
}
```

---

## ğŸ¨ å›¾ç‰‡å¤„ç†æŠ€å·§

### æŠ–åŠ¨ç®—æ³•æ•ˆæœå¯¹æ¯”ï¼š

| æ¨¡å¼ | æ•ˆæœ | é€‚ç”¨åœºæ™¯ |
|------|------|---------|
| **é˜ˆå€¼äºŒå€¼åŒ–** | é»‘ç™½åˆ†æ˜ | Logoã€å›¾æ ‡ã€æ–‡å­— |
| **Floyd-Steinberg æŠ–åŠ¨** | ç°é˜¶è¿‡æ¸¡å¹³æ»‘ | ç…§ç‰‡ã€æ¸å˜å›¾ |

### Python ç”Ÿæˆç¤ºä¾‹ï¼š
```python
# é˜ˆå€¼æ¨¡å¼ - é€‚åˆ Logo
{
    "mode": "threshold",
    "threshold": 128
}

# æŠ–åŠ¨æ¨¡å¼ - é€‚åˆç…§ç‰‡
{
    "mode": "dithering"  # æ¨è
}
```

---

## ğŸš€ å®Œæ•´ç¤ºä¾‹é¡¹ç›®

### åœºæ™¯: äº§å“å±•ç¤ºå±
```cpp
void displayProductPage() {
    display.setFullWindow();
    display.firstPage();
    do {
        display.fillScreen(GxEPD_WHITE);
        
        // 1. é¡¶éƒ¨å…¬å¸ Logo (200x60)
        displayImageFromSD("/sd/company_logo_200x60.bin", 20, 10, display);
        
        // 2. ä¸­é—´äº§å“ç…§ç‰‡ (200x200)
        displayImageFromSD("/sd/product_main_200x200.bin", 20, 90, display);
        
        // 3. äº§å“åç§° (ä¸­æ–‡)
        displayChineseText(display, "æ™ºèƒ½æ¸©æ§å™¨", 20, 310);
        
        // 4. åº•éƒ¨å›¾æ ‡æ 
        displayImageFromSD("/sd/icon_wifi_32x32.bin", 10, 360, display);
        displayImageFromSD("/sd/icon_temp_32x32.bin", 60, 360, display);
        displayImageFromSD("/sd/icon_timer_32x32.bin", 110, 360, display);
        
        // 5. çŠ¶æ€æ–‡å­—
        display.setCursor(160, 370);
        display.setTextSize(1);
        display.print("V1.0.2");
        
    } while (display.nextPage());
}
```

---

## ğŸ“¦ æ–‡ä»¶ç»„ç»‡å»ºè®®

```
SDå¡ /sd/
â”œâ”€â”€ images/                    # å›¾ç‰‡ç›®å½•
â”‚   â”œâ”€â”€ splash_240x416.bin    # å¯åŠ¨ç”»é¢
â”‚   â”œâ”€â”€ logo_company.bin      # å…¬å¸ Logo
â”‚   â”œâ”€â”€ product_001.bin       # äº§å“ç…§ç‰‡1
â”‚   â”œâ”€â”€ product_002.bin       # äº§å“ç…§ç‰‡2
â”‚   â”œâ”€â”€ icons/                # å›¾æ ‡å­ç›®å½•
â”‚   â”‚   â”œâ”€â”€ wifi_32x32.bin
â”‚   â”‚   â”œâ”€â”€ battery_32x32.bin
â”‚   â”‚   â””â”€â”€ settings_32x32.bin
â”‚   â””â”€â”€ backgrounds/          # èƒŒæ™¯å›¾
â”‚       â”œâ”€â”€ bg_light.bin
â”‚       â””â”€â”€ bg_dark.bin
â””â”€â”€ fonts/                    # å­—åº“ç›®å½•
    â”œâ”€â”€ fangsong_16x16.bin
    â””â”€â”€ simhei_24x24.bin
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

### 1. æ–‡ä»¶å¤§å°ä¼˜åŒ–
```
å…¨å± 240x416: ~12 KB   âœ… å¯æ¥å—
ä¸­å›¾ 200x200: ~5 KB    âœ… å¾ˆå¥½
å°å›¾ 64x64:   ~0.5 KB  âœ… æä½³
```

### 2. åŠ è½½é€Ÿåº¦
```cpp
// SDå¡è¯»å–é€Ÿåº¦: ~100-500 KB/s
// 240x416 å›¾ç‰‡åŠ è½½æ—¶é—´: ~30-100ms
// å¯ä»¥æ¥å—,ç”¨æˆ·æ— æ„ŸçŸ¥
```

### 3. å†…å­˜å ç”¨
```cpp
// è‡ªåŠ¨ç®¡ç†,ç”¨å®Œå³é‡Šæ”¾
// å³°å€¼å†…å­˜: å›¾ç‰‡å¤§å° + å°‘é‡å¼€é”€
// 240x416 = 12KB + overhead â‰ˆ 15KB
```

---

## ğŸ¯ æ€»ç»“

**âœ… å›¾ç‰‡å¯ä»¥è½¬æ¢ä¸º .bin æ–‡ä»¶ï¼**

ä¼˜åŠ¿:
- ğŸ’¾ èŠ‚çœ Flash ç©ºé—´ (SDå¡å­˜å‚¨)
- ğŸ”„ åŠ¨æ€æ›´æ¢å›¾ç‰‡ (æ— éœ€é‡ç¼–è¯‘)
- ğŸ“ æ–‡ä»¶å°å·§ (å‹ç¼©æ•ˆç‡é«˜)
- ğŸ¨ æ”¯æŒæŠ–åŠ¨ç®—æ³• (å¢¨æ°´å±ä¼˜åŒ–)
- ğŸš€ åŠ è½½å¿«é€Ÿ (ç›´æ¥äºŒè¿›åˆ¶è¯»å–)

é€‚ç”¨åœºæ™¯:
- å…¬å¸ Logo/å“ç‰Œæ ‡è¯†
- äº§å“å±•ç¤ºç…§ç‰‡
- UI å›¾æ ‡ (WiFiã€ç”µæ± ç­‰)
- å¯åŠ¨ç”»é¢/æ¬¢è¿é¡µ
- èƒŒæ™¯è£…é¥°å›¾æ¡ˆ

é…åˆå­—åº“ .bin ä½¿ç”¨,å¯ä»¥æ‰“é€ å®Œç¾çš„å¢¨æ°´å±ç•Œé¢ï¼
